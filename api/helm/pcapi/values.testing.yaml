# Default values for passculture.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

gcp:
  projectId: passculture-metier-ehp
  appName: pcapi-testing

image:
  repository: europe-west1-docker.pkg.dev/passculture-infra-prod/pass-culture-artifact-registry/pcapi
  tag: latest
  pullPolicy: Always

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

podDisruptionBudget:
  enabled: true
  minAvailable: 1

podAnnotations: {}
podSecurityContext: {}
securityContext: {}
nodeSelector: {}
tolerations: []
affinity: {}
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: metier-testing-pcapi@passculture-metier-ehp.iam.gserviceaccount.com

### API deployment ###
api:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  service:
    type: ClusterIP
    port: 80

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 700m
      memory: 1536Mi

  replicaCount: 1
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    # Enable this option to scale on memory percentage
    # targetMemoryUtilization: 70

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /
      - host: backend.testing.passculture.team
        paths:
          - path: /
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

### High Latency API deployment ###
highLatencyApi:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 700m
      memory: 1536Mi

  replicaCount: 1
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    # Enable this option to scale on memory percentage
    # targetMemoryUtilization: 70

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /bookings/pro$
          - path: /offers$
          - path: /offers/all-active-status$
          - path: /offerers$
          - path: /offerers/(.*)$
          - path: /venues$
          - path: /venues/(.*)/stats$
          - path: /venueProviders$
      - host: backend.testing.passculture.team
        paths:
          - path: /bookings/pro$
          - path: /offers$
          - path: /offers/all-active-status$
          - path: /offerers$
          - path: /offerers/(.*)$
          - path: /venues$
          - path: /venues/(.*)/stats$
          - path: /venueProviders$
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

### Signin deployment ###
signinApi:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  service:
    type: ClusterIP
    port: 80

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 700m
      memory: 1536Mi

  replicaCount: 1
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    # Enable this option to scale on memory percentage
    # targetMemoryUtilization: 70

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/limit-rpm: "10"
      nginx.ingress.kubernetes.io/limit-burst-multiplier: "1"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        limit_req_status 429;
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /users/signin
          - path: /beneficiaries/signin
          - path: /native/v1/signin
      - host: backend.testing.passculture.team
        paths:
          - path: /users/signin
          - path: /beneficiaries/signin
          - path: /native/v1/signin
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

### Admin deployment ###
admin:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  service:
    type: ClusterIP
    port: 80

  replicaCount: 1
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /pc/back-office/
      - host: backend.testing.passculture.team
        paths:
          - path: /pc/back-office/
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

### Worker deployment ###
workers:
  - name: worker
    enabled: true
    replicaCount: 1
    command:
      - flask
    args:
      - worker
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 300m
        memory: 384Mi
  - name: worker-low
    enabled: true
    replicaCount: 1
    command:
      - flask
    args:
      - worker
      - low
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 300m
        memory: 384Mi
  - name: worker-idcheck
    enabled: true
    replicaCount: 1
    command:
      - flask
    args:
      - worker
      - id_check
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 300m
        memory: 384Mi

### Cron deployments ###
crons:
  replicaCount: 1

  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 300m
      memory: 768Mi

  cron:
    import_users:
      enabled: false
      command:
        - python
      args:
        - echo
        - "Wrong_Env"
    clock:
      enabled: true
      command:
        - flask
      args:
        - clock
    algolia:
      enabled: true
      command:
        - flask
      args:
        - algolia_clock
    titelive:
      enabled: true
      command:
        - flask
      args:
        - titelive_clock
    sandbox_deployer:
      enabled: true
      schedule: "0 23 * * 1"
      command:
        - flask
      args:
        - sandbox
        - --name=industrial

### Console deployment ###
console:
  enabled: true

  replicaCount: 1

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 200m
      memory: 512Mi

# Deployment specific for uploading the identity_document
# the route is /native/v1/identity_document
uploadIdentityDocument:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 700m
      memory: 1536Mi

  replicaCount: 1
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    # Enable this option to scale on memory percentage
    # targetMemoryUtilization: 70

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /native/v1/identity_document$
      - host: backend.testing.passculture.team
        paths:
          - path: /native/v1/identity_document$
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

# Deployment for all cloud tasks
cloudTasks:
  enabled: true

  containerPort: 5000

  probePath: /health/api

  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 700m
      memory: 1536Mi

  replicaCount: 1
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    # Enable this option to scale on memory percentage
    # targetMemoryUtilization: 70

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers -s 503 'Access-Control-Allow-Headers: AppName,AppVersion,X-Request-ID,Content-Type';
        more_set_headers -s 503 'Access-Control-Allow-Origin: $http_origin';
        more_set_headers -s 503 'Access-Control-Allow-Credentials: true';
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: backend.passculture-testing.beta.gouv.fr
        paths:
          - path: /cloud-tasks/(.*)$
      - host: backend.testing.passculture.team
        paths:
          - path: /cloud-tasks/(.*)$
    tls:
      - secretName: pcapi-ingress-cert
        hosts:
          - backend.passculture-testing.beta.gouv.fr
          - backend.testing.passculture.team

aide:
  enabled: false

configmapApi:
  DATABASE_STATEMENT_TIMEOUT: 60000

configmap:
  ENV: testing
  FIREBASE_DYNAMIC_LINKS_URL: https://passcultureapptesting.page.link
  GCP_BUCKET_NAME: passculture-metier-ehp-testing-assets
  GUNICORN_PORT: 5000
  GUNICORN_MAX_REQUESTS: 3000
  GUNICORN_MAX_REQUESTS_JITTER: 10
  GUNICORN_WORKERS: 2
  GUNICORN_THREADS: 5
  GUNICORN_TIMEOUT: 90
  GUNICORN_LOG_LEVEL: info
  ID_CHECK_MAX_ALIVE_TOKEN: 4
  OBJECT_STORAGE_PROVIDER: GCP
  MAX_SMS_SENT_FOR_PHONE_VALIDATION: 5
  MAX_PHONE_VALIDATION_ATTEMPTS: 5
  NATIVE_APP_MINIMAL_CLIENT_VERSION: "1.142.0"
  DATABASE_IDLE_IN_TRANSACTION_SESSION_TIMEOUT: "1800000"

configmapCloudTasks:
  GUNICORN_THREADS: 10

configmapUploadIdentityDocument:
  GUNICORN_THREADS: 10

secrets:
  - name: ADAGE_API_KEY
  - name: APPS_FLYER_ANDROID_API_KEY
  - name: APPS_FLYER_IOS_API_KEY
  - name: ADMINISTRATION_EMAIL_ADDRESS
  - name: ALGOLIA_API_KEY
  - name: ALGOLIA_APPLICATION_ID
  - name: ALLOCINE_API_KEY
  - name: APPSEARCH_API_KEY
  - name: APPSEARCH_HOST
  - name: BATCH_SECRET_API_KEY
  - name: BLACKLISTED_SMS_RECIPIENTS
  - name: CLOUD_TASK_BEARER_TOKEN
  - name: COMPLIANCE_EMAIL_ADDRESS
  - name: DATABASE_URL
  - name: DEMARCHES_SIMPLIFIEES_TOKEN
  - name: DEMARCHES_SIMPLIFIEES_WEBHOOK_TOKEN
  - name: DEV_EMAIL_ADDRESS
  - name: EAC_API_KEY
  - name: EDUCONNECT_SP_CERTIFICATE
  - name: EDUCONNECT_SP_PRIVATE_KEY
  - name: EXPORT_TOKEN
  - name: FLASK_SECRET
  - name: FTP_TITELIVE_PWD
  - name: FTP_TITELIVE_URI
  - name: FTP_TITELIVE_USER
  - name: GCP_BUCKET_CREDENTIALS
  - name: OBJECT_STORAGE_URL
  - name: ID_CHECK_MIDDLEWARE_TOKEN
  - name: JOUVE_API_DOMAIN
  - name: JOUVE_PASSWORD
  - name: JOUVE_USERNAME
  - name: JOUVE_VAULT_GUID
  - name: JWT_SECRET_KEY
  - name: MAILJET_API_KEY
  - name: MAILJET_API_SECRET
  - name: NATIVE_RECAPTCHA_SECRET
  - name: NOTION_TOKEN
  - name: OVH_BUCKET_NAME
  - name: OVH_PASSWORD
  - name: OVH_REGION_NAME
  - name: OVH_TENANT_NAME
  - name: OVH_USER
  - name: PASS_CULTURE_BIC
  - name: PASS_CULTURE_IBAN
  - name: PASS_CULTURE_REMITTANCE_CODE
  - name: PAYMENTS_DETAILS_RECIPIENTS
  - name: PAYMENTS_REPORT_RECIPIENTS
  - name: PROVIDER_FNAC_BASIC_AUTHENTICATION_TOKEN
  - name: RECAPTCHA_SECRET
  - name: REDIS_URL
  - name: SENDINBLUE_API_KEY
  - name: SENTRY_DSN
  - name: SUPPORT_EMAIL_ADDRESS
  - name: TRANSACTIONS_RECIPIENTS
  - name: UBBLE_CLIENT_ID
  - name: UBBLE_CLIENT_SECRET
  - name: USER_PROFILING_URL
  - name: USER_PROFILING_ORG_ID
  - name: USER_PROFILING_API_KEY
  - name: WALLET_BALANCES_RECIPIENTS
  - name: WHITELISTED_EMAIL_RECIPIENTS
  - name: WHITELISTED_SMS_RECIPIENTS
  - name: REPORT_OFFER_EMAIL_ADDRESS
