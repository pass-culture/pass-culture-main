import logging
import time
import typing

from pcapi.app import app
from pcapi.core import search
from pcapi.core.offers.models import Offer


BATCH_SIZE = 1000

logger = logging.getLogger(__name__)


def get_offer_ids() -> typing.Generator[list, None, None]:
    fixed_venues_ids = (
        32214,
        63008,
        28324,
        109357,
        119126,
        42133,
        111441,
        97,
        94940,
        113144,
        113094,
        94487,
        99755,
        104003,
        11963,
        114843,
        13102,
        116961,
        1122,
        108355,
        44878,
        101516,
        114506,
        102971,
        108461,
        107195,
        130511,
        52115,
        107234,
        119835,
        107946,
        107251,
        16655,
        90555,
        107254,
        90569,
        108873,
        105638,
        103004,
        114861,
        93048,
        11284,
        101547,
        109051,
        113158,
        5288,
        121033,
        101576,
        100092,
        110207,
        107824,
        11124,
        110769,
        101604,
        101600,
        84865,
        17046,
        111532,
        119161,
        50553,
        107838,
        116736,
        112563,
        102568,
        26330,
        106931,
        110853,
        93170,
        94962,
        107845,
        116257,
        111540,
        81149,
        109594,
        114364,
        106905,
        13100,
        121106,
        92183,
        103081,
        14047,
        54864,
        51662,
        50983,
        25350,
        125472,
        115337,
        92709,
        115862,
        109116,
        109626,
        119949,
        100417,
        57253,
        3067,
        115085,
        107494,
        105566,
        91037,
        110913,
        101723,
        113414,
        104440,
        104423,
        117446,
        107546,
        27928,
        103144,
        117434,
        107880,
        110195,
        112033,
        42,
        88004,
        58425,
        108091,
        88077,
        113236,
        88125,
        88153,
        108557,
        88192,
        105937,
        88213,
        52973,
        88261,
        88403,
        109173,
        108106,
        88436,
        88435,
        88453,
        88456,
        108624,
        126020,
        82729,
        116334,
        110039,
        120054,
        99865,
        88510,
        120858,
        105965,
        105413,
        98572,
        105969,
        113212,
        14448,
        103173,
        110366,
        107590,
        8850,
        113103,
        108654,
        116338,
        114911,
        115891,
        115420,
        110672,
        59802,
        114003,
        103204,
        114413,
        105141,
        115130,
        129754,
        121220,
        120606,
        120614,
        43015,
        114931,
        91284,
        127603,
        110066,
        92392,
        60412,
        103216,
        102160,
        112106,
        114009,
        115104,
        105290,
        39742,
        115304,
        47170,
        114423,
        118004,
        112863,
        27458,
        111304,
        111306,
        104103,
        121368,
        115934,
        114968,
        105774,
        121260,
        120698,
        120147,
        9566,
        61376,
        104183,
        110476,
        105801,
        115465,
        92476,
        113301,
        112684,
        116360,
        100160,
        115012,
        79487,
        108231,
        11812,
        13554,
        88575,
        114453,
        98641,
        96879,
        101966,
        118426,
        102865,
        59128,
        120792,
        120814,
        101985,
        105851,
        51504,
        120818,
        8022,
        93674,
        13452,
        105496,
        105872,
        100035,
        113676,
        119534,
        54543,
        98316,
        113970,
        93785,
        119613,
        117764,
        119703,
        120240,
        105975,
        109170,
        14617,
        108786,
        101698,
        120271,
        120278,
        103383,
        89722,
        90014,
        104608,
        120288,
        91038,
        50749,
        116023,
        106004,
        115975,
        118265,
        92077,
        8011,
        104611,
        112728,
        113373,
        111705,
        115742,
        89793,
        130411,
        94479,
        121853,
        114945,
        62420,
        105007,
        51204,
        106049,
        98766,
        19859,
        129386,
        102493,
        106441,
        104270,
        104269,
        117830,
        103592,
        105468,
        21348,
        103995,
        100463,
        106094,
        114735,
        53326,
        22082,
        101303,
        97298,
        88007,
        100489,
        101328,
        106464,
        33090,
        112980,
        23446,
        105364,
        96190,
        96192,
        101391,
        106484,
        102658,
        103654,
        117219,
        102660,
        101398,
        100638,
        102566,
        102753,
        42243,
        106190,
        106509,
        101135,
        27256,
        103924,
        102593,
        97917,
        102681,
        104878,
        102434,
        130253,
        100811,
        102603,
        94834,
        100637,
        29048,
        104901,
        96525,
        106625,
        60415,
        130576,
        106231,
        30779,
        55082,
        104953,
        106265,
        33465,
        106541,
        106543,
        105004,
        106331,
        105039,
        130879,
        105301,
        129995,
        130963,
        106376,
        106574,
        106386,
        130263,
        130924,
        130922,
        130941,
        130949,
        130525,
        106422,
        130891,
        117264,
        130141,
        130836,
        130902,
        130960,
        130874,
        121633,
        115180,
        84748,
        974,
        129984,
        50269,
        66941,
        205,
        50312,
        50356,
        50367,
        50371,
        50364,
        50369,
        50373,
        50385,
        50395,
        50451,
        50445,
        50474,
        1221,
        1021,
        1823,
        50561,
        100138,
        100213,
        114134,
        114740,
        114171,
        2114,
        130604,
        2514,
        134142,
        130608,
        3664,
        130345,
        3317,
        112,
        4805,
        5651,
        127435,
        6416,
        130824,
        6144,
        130833,
        130856,
        130863,
        130882,
        7739,
        130906,
        130907,
        130908,
        130911,
        130916,
        130917,
        130925,
        101692,
        130927,
        130929,
        130936,
        130944,
        130954,
        130959,
        111127,
        122348,
        9313,
        9431,
        10121,
        130126,
        10752,
        130024,
        93977,
        12681,
        12018,
        130043,
        112471,
        106101,
        107710,
        103845,
        114490,
        127546,
        13960,
        32356,
        64313,
        115428,
        131108,
        50977,
        50980,
        15202,
        15767,
        15155,
        15067,
        16729,
        17058,
        17440,
        130388,
        17372,
        18123,
        42207,
        18925,
        107191,
        19929,
        19345,
        20992,
        128105,
        116616,
        20086,
        20136,
        55255,
        21342,
        21004,
        21300,
        98215,
        130075,
        22665,
        22803,
        112556,
        123816,
        23289,
        23062,
        130358,
        130360,
        130361,
        23900,
        23890,
        24802,
        24533,
        134169,
        104158,
        24398,
        25641,
        25357,
        26106,
        26730,
        26504,
        26940,
        130111,
        27805,
        27192,
        27212,
        130115,
        27747,
        28270,
        105154,
        60632,
        29650,
        127841,
        29095,
        65359,
        49172,
        27611,
        30448,
        30207,
        30562,
        30355,
        30064,
        30370,
        130742,
        31721,
        31658,
        31659,
        31660,
        31662,
        32096,
        32914,
        10103,
        33406,
        33693,
        40906,
        131033,
        130675,
        33195,
        34432,
        126153,
        35342,
        35829,
        54148,
        37922,
        37934,
        105771,
        11540,
        37975,
        38862,
        33300,
        58706,
        38100,
        78421,
        120381,
        136147,
        39722,
        38157,
        39464,
        40254,
        40471,
        126141,
        40562,
        53212,
        130398,
        130403,
        111356,
        41016,
        41011,
        41055,
        41574,
        26678,
        42591,
        109164,
        36988,
        84183,
        91641,
        95405,
        97070,
        110385,
        51078,
        43236,
        131144,
        122623,
        130783,
        99687,
        43463,
        115848,
        104192,
        45611,
        130175,
        108215,
        92,
        46982,
        47179,
        124031,
        47162,
        47311,
        46473,
        112871,
        48248,
        131221,
        49008,
        49225,
        51547,
        39323,
        89358,
        51586,
        91915,
        52821,
        53288,
        53694,
        53265,
        24453,
        128615,
        54826,
        54985,
        54215,
        130823,
        54437,
        54516,
        130964,
        55355,
        55564,
        55134,
        55289,
        55595,
        55956,
        56284,
        56003,
        56337,
        56127,
        56215,
        50447,
        57178,
        57814,
        57076,
        57162,
        57976,
        50362,
        31948,
        58518,
        58173,
        130221,
        120696,
        58354,
        130223,
        68360,
        130335,
        107445,
        50370,
        60425,
        121823,
        61324,
        61643,
        128066,
        61601,
        62870,
        62795,
        62395,
        12840,
        62014,
        63618,
        63356,
        63358,
        63412,
        63643,
        63459,
        49416,
        131166,
        87986,
        65198,
        128978,
        65358,
        65403,
        111366,
        32941,
        112708,
        117246,
        65485,
        35261,
        66821,
        117202,
        116801,
        69917,
        69210,
        70194,
        70808,
        101002,
        109641,
        61082,
        101567,
        130421,
        22526,
        130434,
        80577,
        71611,
        71612,
        71251,
        130603,
        72402,
        101218,
        106778,
        99126,
        123993,
        73399,
        73842,
        73196,
        73198,
        73286,
        73534,
        73671,
        128528,
        106721,
        129706,
        74431,
        74795,
        75014,
        75107,
        75946,
        75429,
        76586,
        76589,
        76781,
        76122,
        76238,
        41206,
        119366,
        77553,
        77684,
        77190,
        79706,
        57890,
        78300,
        121987,
        131292,
        126826,
        5511,
        106253,
        78559,
        78555,
        79233,
        131456,
        79111,
        58116,
        79624,
        104846,
        80374,
        112566,
        80150,
        81503,
        82156,
        82638,
        128113,
        82578,
        83465,
        83640,
        83764,
        128920,
        84427,
        84134,
        84232,
        131339,
        129991,
        85570,
        124618,
        124574,
        85084,
        85619,
        108225,
        85000,
        86943,
        50378,
        86602,
        137855,
        86461,
        87894,
        87925,
        87903,
        87943,
        87957,
        87981,
        87982,
        87992,
        127810,
        87242,
        87269,
        87275,
        87257,
        88563,
        108966,
        124493,
        107441,
        92828,
        95104,
        45802,
        96676,
        97182,
        98765,
        47249,
        101672,
        48073,
        55580,
        121845,
        101243,
        101428,
        102018,
        118055,
        102013,
        102466,
        102403,
        102464,
        102781,
        138057,
        102601,
        103303,
        103177,
        104417,
        105401,
        104037,
        105579,
        105248,
        105250,
        106780,
        106486,
        106171,
        111544,
        10376,
        99383,
        108261,
        121341,
        109730,
        109785,
        109029,
        110344,
        14357,
        111944,
        113306,
        113395,
        113181,
        113074,
        113572,
        100033,
        114244,
        114163,
        114204,
        114203,
        114958,
        114712,
        115191,
        115678,
        115471,
        73300,
        116104,
        113507,
        116232,
        116663,
        116924,
        116536,
        116533,
        116587,
        116939,
        26939,
        88091,
        117533,
        117695,
        117676,
        118576,
        118454,
        115694,
        118131,
        119243,
        118863,
        118418,
        118066,
        118521,
        118558,
        119353,
        119326,
        119209,
        119315,
        127962,
        124049,
        104966,
        121868,
        126167,
        122064,
        108188,
        102112,
        125546,
        45082,
        117944,
        17040,
        122236,
        102794,
        122244,
        122278,
        47181,
        122289,
        122313,
        10343,
        122593,
        129269,
        122652,
        126531,
        108480,
        108346,
        119521,
        127991,
        109185,
        123941,
        124504,
        124184,
        788,
        110728,
        3321,
        109176,
        770,
        128972,
        103889,
        110426,
        113524,
        28439,
        110962,
        54414,
        74076,
        57501,
        126891,
        85329,
        118832,
        112060,
        119495,
        36217,
        49155,
        98335,
        127613,
        125535,
        4454,
        104017,
        34584,
        49898,
        110137,
        120639,
        50398,
        119486,
        126021,
        118712,
        23619,
        81608,
        125543,
        122523,
        50386,
        129364,
        100382,
        62498,
        16708,
        49768,
        97290,
        128283,
        52853,
        84340,
        73734,
        86862,
        106234,
        127461,
        1046,
        31652,
        69931,
        126920,
        108583,
        114569,
        126581,
        104475,
        114725,
        120016,
        115865,
        80012,
        107084,
        115684,
        97056,
        119010,
        138579,
        88476,
        23724,
        107645,
        40674,
        101313,
        34380,
        36882,
        116489,
        34689,
        80557,
        110204,
        45372,
        126949,
        128061,
        71252,
        108866,
        124562,
        126971,
        131419,
        131431,
        36902,
        14376,
        16451,
        67,
        90803,
        106883,
        84167,
        97689,
        104407,
        125856,
        116463,
        40711,
        54471,
        120024,
        13903,
        118905,
        52187,
        103095,
        76488,
        107863,
        120376,
        106070,
        101229,
        8954,
        112100,
        112075,
        112166,
        49997,
        119264,
        131443,
        109102,
        2892,
        119543,
        68343,
        128705,
        91792,
        23100,
        127716,
        129464,
        129050,
        41865,
        113595,
        60725,
        75046,
        80675,
        116146,
        119548,
        119536,
        70878,
        102101,
        102102,
        128106,
        64814,
        73045,
        91993,
        129488,
        46194,
        49127,
        125620,
        95696,
        126324,
        112306,
        124208,
        124304,
        50638,
        2836,
        116543,
        127731,
        114591,
        97637,
        99731,
        113064,
        88208,
        110499,
        114918,
        126408,
        110482,
        118498,
        98743,
        98742,
        118916,
        57776,
        17647,
        2079,
        110909,
        102051,
        97793,
        86886,
        51073,
        113154,
        22317,
        124608,
        128534,
        129064,
        53639,
        85082,
        86463,
        111167,
        106245,
        99575,
        44186,
        113036,
        14087,
        118701,
        110430,
        119878,
        100461,
        121051,
        116917,
        127755,
        121103,
        52477,
        121406,
        103161,
        88406,
        99987,
        98226,
        115413,
        106279,
        126395,
        102615,
        19239,
        128107,
        125897,
        98635,
        128157,
        98626,
        81911,
        86427,
        50615,
        105961,
        50982,
        127749,
        103613,
        103953,
        107948,
        124333,
        48690,
        120683,
        63891,
        52400,
        125903,
        128369,
        128583,
        128565,
        131484,
        128845,
        125685,
        125723,
        126083,
        127779,
        48260,
        124338,
        45736,
        131503,
        131095,
        103424,
        125695,
        98884,
        105726,
        127715,
        124356,
        124407,
        126482,
        127785,
        126502,
        131535,
        129576,
        111114,
        103442,
        120526,
        124350,
        128591,
        284,
        87558,
        82681,
        91587,
        139884,
        126042,
        111276,
        34424,
        129866,
        124405,
        127379,
        132857,
        128221,
        124413,
        125718,
        127130,
        125245,
        88442,
        77486,
        113222,
        63084,
        73149,
        126446,
        2891,
        9937,
        129913,
        123955,
        131602,
        47617,
        121448,
        5776,
        129128,
        107464,
        48827,
        82010,
        124441,
        101675,
        127146,
        129638,
        25275,
        125731,
        18595,
        25356,
        127410,
        60820,
        127156,
        112246,
        127866,
        123814,
        127868,
        127161,
        52533,
        115805,
        127873,
        111444,
        90826,
        79948,
        107891,
        128631,
        8830,
        35181,
        128931,
        108414,
        78551,
        89810,
        100812,
        115820,
        110807,
        114505,
        128936,
        84142,
        94485,
        8345,
        127911,
        57508,
        108725,
        113139,
        89807,
        111368,
        128940,
        121201,
        108513,
        111193,
        44494,
        127930,
        105454,
        109733,
        121005,
        128944,
        126500,
        130930,
        130933,
        130940,
        130942,
        64385,
        117010,
        110879,
        125450,
        50366,
        125997,
        113833,
        112646,
        115345,
        4483,
        126503,
        102513,
        64260,
        117861,
        108864,
        24501,
        103951,
        56618,
        127881,
        109898,
        206,
        65488,
        55357,
        58135,
        35700,
        17427,
        17431,
        66561,
    )
    query = Offer.query.filter(Offer.venueId.in_(fixed_venues_ids), Offer.isActive.is_(True)).with_entities(Offer.id)
    yield from query.yield_per(BATCH_SIZE)


def reindex_offers() -> None:
    batch = []
    start_time = time.time()
    prev_time = start_time
    for (offer_id,) in get_offer_ids():
        batch.append(offer_id)
        if len(batch) >= BATCH_SIZE:
            search.reindex_offer_ids(batch)
            next_time = time.time()
            delta = round(next_time - prev_time, 3)
            logger.info("Batch loaded in %s", delta)
            prev_time = next_time
            batch = []

    total_delta = round(time.time() - start_time, 2)
    logger.info("Total in %s", total_delta)


with app.app_context():
    reindex_offers()
