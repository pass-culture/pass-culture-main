from pcapi import settings
from pcapi.app import app
from pcapi.core.external.zendesk_sell_backends import BaseBackend
from pcapi.core.external.zendesk_sell_backends import base as zendesk_sell
from pcapi.core.offerers import models as offerers_models
from pcapi.utils import requests
from pcapi.utils.module_loading import import_string


VENUE_IDS = [
    32723,
    3223,
    6645,
    8667,
    7233,
    47562,
    109638,
    1811,
    3250,
    3253,
    3254,
    3256,
    3252,
    3251,
    3255,
    108506,
    61627,
    21858,
    16618,
    118839,
    15932,
    15361,
    53385,
    50751,
    53369,
    7259,
    44867,
    1637,
    29192,
    23669,
    19251,
    18956,
    42178,
    129197,
    39943,
    33644,
    41499,
    42406,
    72638,
    34445,
    28132,
    23684,
    122132,
    20364,
    135007,
    29009,
    24229,
    39320,
    38811,
    13381,
    20415,
    108015,
    14336,
    15904,
    15905,
    121840,
    63491,
    57285,
    45460,
    52141,
    44572,
    29736,
    53442,
    17504,
    56088,
    23515,
    66110,
    128049,
    108978,
    4153,
    61023,
    6800,
    15838,
    15842,
    15837,
    30891,
    30891,
    40219,
    7394,
    3631,
    4114,
    4455,
    339,
    5556,
    5401,
    5008,
    8811,
    6078,
    6078,
    4722,
    5334,
    4559,
    35557,
    35881,
    85407,
    15753,
    15754,
    49736,
    71551,
    33445,
    4629,
    4459,
    54672,
    1713,
    293,
    2823,
    120551,
    2528,
    2531,
    294,
    1063,
    300,
    272,
    5330,
    43409,
    31478,
    94697,
    34134,
    4094,
    79632,
    4201,
    103485,
    103481,
    11659,
    11658,
    11661,
    11660,
    111981,
    11502,
    11499,
    11506,
    12278,
    11619,
    13877,
    68836,
    15593,
    12166,
    11395,
    43497,
    68772,
    50249,
    12307,
    44268,
    38429,
    44191,
    44254,
    12442,
    11877,
    44263,
    54026,
    33457,
    27962,
    122319,
    140137,
    122654,
    13834,
    11783,
    11221,
    134854,
    5730,
    5731,
    7059,
    4482,
    15543,
    53818,
    51581,
    9255,
    66999,
    43981,
    118297,
    67006,
    41806,
    13595,
    13598,
    15352,
    7157,
    7153,
    29424,
    7152,
    22698,
    7471,
    59503,
    26175,
    26174,
    7271,
    19996,
    19065,
    13564,
    49606,
    42521,
    3504,
    3505,
    11203,
    11202,
    7732,
    7591,
    70323,
    3497,
    91989,
    52311,
    30768,
    33538,
    103941,
    109695,
    55992,
    56022,
    12087,
    39586,
    98373,
    10933,
    3062,
    8879,
    24677,
    35825,
    53334,
    20709,
    39068,
    20672,
    20710,
    85036,
    20748,
    19938,
    7003,
    55527,
    70850,
    102764,
    15748,
    107165,
    21859,
    55148,
    193,
    2338,
    7924,
    4264,
    9170,
    32385,
    13215,
    119897,
    118147,
    121106,
    10374,
    20863,
    20867,
    7068,
    2379,
    2378,
    223,
    8048,
    7802,
    2840,
    2967,
    2377,
    3227,
    3266,
    167,
    1845,
    98254,
    13081,
    78734,
    36320,
    36324,
    11684,
    36825,
    48135,
    12736,
    24272,
    13282,
    37004,
    29873,
    66606,
    15371,
    1795,
    15288,
    16768,
    15292,
    6904,
    11757,
    9889,
    14099,
    12153,
    13443,
    14120,
    14121,
    3435,
    8396,
    42811,
    14259,
    14180,
    11871,
    37394,
    43270,
    41334,
    12238,
    12250,
    8212,
    85034,
    85052,
    80485,
    94639,
    11258,
    11237,
    56191,
    22253,
    98792,
    26728,
    19910,
    19913,
    19912,
    14195,
    25702,
    121409,
    13512,
    29648,
    49567,
    57915,
    71017,
    10426,
    77396,
    18877,
    20216,
    90708,
    72973,
    12949,
    77408,
    65180,
    13800,
    19964,
    13003,
    43573,
    11648,
    55692,
    19089,
    18686,
    27571,
    19935,
    41828,
    20851,
    21716,
    80644,
    85705,
    92130,
    15894,
    35503,
    15790,
    15037,
    21207,
    22951,
    104235,
    55553,
    13392,
    19267,
    58974,
    43758,
    21649,
    21653,
    13225,
    14170,
    114692,
    46742,
    93012,
    23758,
    55489,
    13515,
    21598,
    85348,
    69305,
    36089,
    19246,
    64920,
    50831,
    22394,
    22393,
    16385,
    26464,
    12898,
    129698,
    31911,
    25356,
    139948,
    100203,
    41389,
    92818,
    31909,
    12899,
    83335,
    22121,
    22082,
    31909,
    31905,
    30152,
    44168,
    23818,
    16986,
    51324,
    13536,
    48485,
    32711,
    48574,
    32916,
    13984,
    22147,
    24301,
    12989,
    15034,
    106696,
    25189,
    68848,
    15385,
    15500,
    15849,
    27611,
    113254,
    91719,
    14000,
    18123,
    107784,
    15035,
    15036,
    15843,
    63028,
    15733,
    24177,
    115469,
    19584,
    66816,
    39850,
    12705,
    22387,
    22345,
    15830,
    31551,
    59777,
    62424,
    20896,
    31921,
    17987,
    15741,
    17961,
    23726,
    45377,
    21307,
    17890,
    13789,
    13783,
    13784,
    13950,
    144414,
    31061,
    31062,
    107903,
    25202,
    33763,
    86604,
    16014,
    15676,
    18112,
    13119,
    18177,
    44730,
    20119,
    20251,
    15084,
    15083,
    21507,
    28730,
    42549,
    42550,
    21802,
    74672,
    11942,
    51374,
    11946,
    11928,
    11947,
    11949,
    11950,
    11926,
    13338,
    13473,
    5145,
    15094,
    15096,
    13801,
    31380,
    104362,
    68306,
    68533,
    110204,
    15091,
    7342,
    7344,
    10651,
    10655,
    10652,
    7343,
    10656,
    10650,
    118153,
    32790,
    31471,
    65072,
    134043,
    39858,
    65101,
    133058,
    18100,
    105325,
    43053,
    32710,
    42357,
    37567,
    4471,
    106202,
    15697,
    54016,
    54005,
    49115,
    37992,
    53008,
    54011,
    31841,
    20362,
    70755,
    12485,
    51344,
    73213,
    64299,
    12411,
    15076,
    64729,
    58635,
    99476,
    88695,
    12198,
    104129,
    56222,
    56218,
    56221,
    13328,
    40109,
    32492,
    32492,
    11930,
    73989,
    86532,
    66170,
    32989,
    12162,
    31507,
    12414,
    59158,
    41951,
    62571,
    32908,
    12759,
    57341,
    28054,
    33481,
    58837,
    50652,
    50652,
    57138,
    72497,
    106433,
    20444,
    58987,
    58988,
    75275,
    99177,
    16219,
    12343,
    12384,
    12385,
    98500,
    2986,
    1792,
    24615,
    45176,
    24613,
    12205,
    19314,
    19313,
    13735,
    70333,
    12207,
    36500,
    9710,
    45174,
    63008,
    79802,
    14122,
    49062,
    12408,
    75319,
    14028,
    10657,
    275,
    92230,
    3257,
    22131,
    32658,
    32657,
    32659,
    32661,
    32662,
    32663,
    9431,
    32664,
    83226,
    32666,
    32665,
    32640,
    11732,
    23195,
    55327,
    97774,
    15033,
    44620,
    13475,
    9916,
    63789,
    7040,
    32289,
    35743,
    125355,
    37407,
    83093,
    269,
    90679,
    42793,
    32815,
    107163,
    58352,
    10595,
    35876,
    88815,
    55431,
    13597,
    6671,
    42207,
    24611,
    65101,
    74306,
    49704,
    19249,
    51827,
    91720,
    7892,
    43571,
    54637,
    4336,
    31300,
    5776,
    1646,
    15845,
    13530,
    15309,
    34951,
    6927,
    43978,
    30742,
    94146,
    22315,
    25542,
    116427,
    211,
    1436,
    858,
    7739,
    64486,
    64472,
    7601,
    7612,
    64467,
    2048,
    64683,
    13745,
    7766,
    64485,
    7656,
    7764,
    3163,
    36059,
    71014,
    13049,
    64470,
    64471,
    1339,
    203,
    5391,
    7607,
    1060,
    2330,
    7774,
    7603,
    7972,
    68515,
    65009,
    16344,
    192,
    192,
    22879,
    938,
    224,
    1338,
    2331,
    14165,
    8853,
    6107,
    120184,
    8469,
    6108,
    6109,
    8309,
    6110,
    15071,
    234,
    85702,
    31173,
    60488,
    18744,
    11201,
    29905,
    19316,
    39715,
    38006,
    25603,
    69353,
    11656,
    13959,
    114386,
    41561,
    104235,
    11407,
    60881,
    17505,
    7308,
    38446,
    52470,
    30965,
    10654,
    11830,
    71384,
    79043,
    20865,
    12444,
    91576,
    11381,
    21460,
    33409,
    12441,
    21125,
    3258,
    118296,
    72448,
    33477,
    14173,
]

zendesk_sell_backend: BaseBackend = import_string(settings.ZENDESK_SELL_BACKEND)()


def _get_parent_organization_id(venue: offerers_models.Venue) -> int | None:
    offerer = venue.managingOfferer
    try:
        zendesk_offerer_data = zendesk_sell_backend.get_offerer_by_id(offerer)
    except (zendesk_sell.ContactFoundMoreThanOneError, zendesk_sell.ContactNotFoundError):
        # no parent or several parents: ignore, nothing to update
        return None
    except requests.exceptions.HTTPError as http_error:
        raise ValueError(f"Une erreur {http_error.response.status_code} s'est produite : {http_error}")

    return zendesk_offerer_data["id"]


def update_venue(venue_id: int) -> None:
    venue = offerers_models.Venue.query.filter_by(id=venue_id).one_or_none()
    if not venue:
        raise ValueError("Partenaire culturel introuvable")

    if venue.isVirtual or not venue.isOpenToPublic:
        raise ValueError("Le partenaire culturel est virtuel ou n'est pas ouvert au public")

    try:
        zendesk_venue_data = zendesk_sell_backend.get_venue_by_id(venue)
    except zendesk_sell.ContactFoundMoreThanOneError as e:
        message = (
            "Plusieurs partenaires culturels ont été trouvés dans Zendesk Sell, aucun ne peut donc être mis à jour :"
        )
        for item in e.items:
            message += (
                f' - Identifiant Zendesk Sell : {item["id"]}, '
                f'Produit Venue ID : {item["custom_fields"][zendesk_sell.ZendeskCustomFieldsShort.PRODUCT_VENUE_ID.value]}, '
                f'SIRET : {item["custom_fields"][zendesk_sell.ZendeskCustomFieldsShort.SIRET.value]}'
            )
        raise ValueError(message)
    except zendesk_sell.ContactNotFoundError:
        raise ValueError("Le partenaire culturel n'a pas été trouvé dans Zendesk Sell")
    except requests.exceptions.HTTPError as http_error:
        raise ValueError(f"Une erreur {http_error.response.status_code} s'est produite : {http_error}")

    try:
        zendesk_venue_id = zendesk_venue_data["id"]
        parent_organization_id = _get_parent_organization_id(venue)
        zendesk_sell_backend.update_venue(zendesk_venue_id, venue, parent_organization_id)
    except requests.exceptions.HTTPError as http_error:
        raise ValueError(f"Une erreur {http_error.response.status_code} s'est produite : {http_error}")


if __name__ == "__main__":
    app.app_context().push()

    for venue_id_ in VENUE_IDS:
        try:
            update_venue(venue_id_)
        except Exception as e:  # pylint: disable=broad-except
            print(f"Venue ID {venue_id_}: {str(e)}")

    print("Done")
