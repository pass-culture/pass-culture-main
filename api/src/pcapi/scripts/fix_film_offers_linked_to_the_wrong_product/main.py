"""
Job console documentation here: https://www.notion.so/passcultureapp/Documentation-Job-Console-769beeacd5a146de9c97b6f8ee544276
Assumed path to the script (copy-paste in github actions):

https://github.com/pass-culture/pass-culture-main/blob/master/api/src/pcapi/scripts/fix_film_offers_linked_to_the_wrong_product/main.py

"""

import argparse
import logging
from functools import partial

from pcapi.app import app
from pcapi.core import search
from pcapi.core.offers import models as offers_models
from pcapi.models import db
from pcapi.repository.session_management import on_commit


logger = logging.getLogger(__name__)

_OFFERS_TO_PRODUCTS_MAPPING: list[tuple[int, int | None]] = [
    # Fix link
    (321865971, 6209885),
    (324179102, 6234247),
    (316177062, 6250186),
    (319838277, 6266019),
    (318930081, 6276197),
    (321866148, 6298309),
    (315192883, 6303149),
    (324178076, 6311349),
    (332131177, 6403069),
    (321866233, 6405922),
    (324182629, 6410560),
    (317845108, 6437498),
    (316466394, 6453390),
    (318740931, 6458270),
    (319056499, 6464148),
    (315154791, 6474594),
    (315330804, 6478696),
    (316789659, 6486438),
    (315153297, 6486438),
    (315154792, 6491540),
    (318930080, 6491540),
    (315330805, 6491540),
    (317501148, 6491548),
    (315733682, 6492049),
    (316789577, 6492049),
    (315323455, 6492049),
    (315737445, 6492049),
    (315332054, 6492049),
    (317257022, 6492049),
    (317267811, 6492049),
    (316201915, 6492049),
    (316543292, 6492049),
    (318771680, 6492049),
    (316455895, 6492049),
    (317750729, 6492049),
    (316543262, 6492049),
    (317268013, 6492049),
    (318132007, 6492049),
    (315331553, 6492049),
    (316698775, 6492049),
    (316698866, 6492049),
    (316833052, 6492049),
    (315505930, 6492049),
    (317941105, 6492049),
    (315505906, 6492049),
    (316590974, 6492049),
    (317367509, 6492049),
    (316671887, 6492049),
    (315525837, 6492049),
    (316504624, 6492049),
    (316882137, 6492049),
    (316801817, 6492049),
    (316671783, 6492049),
    (317885855, 6492049),
    (316663632, 6492049),
    (315594983, 6492049),
    (315319994, 6492049),
    (315613063, 6492049),
    (317844236, 6492049),
    (316428297, 6492049),
    (317639643, 6492049),
    (316690670, 6492049),
    (315519545, 6492049),
    (315489608, 6492049),
    (316881898, 6492049),
    (318747545, 6492302),
    (316176940, 6492302),
    (315504264, 6492302),
    (315331566, 6492302),
    (320526589, 6494422),
    (318003809, 6494422),
    (315622514, 6494422),
    (315875567, 6501998),
    (324182630, 6507188),
    (318546722, 6507188),
    (318570600, 6507188),
    (317324780, 6507188),
    (316799145, 6507188),
    (318799069, 6507188),
    (324182631, 6508152),
    (315736788, 6508152),
    (318929660, 6508152),
    (315731276, 6508152),
    (319624533, 6509628),
    (317927560, 6509628),
    (319543411, 6509628),
    (315489452, 6513169),
    (323864279, 6513169),
    (318595384, 6514580),
    (324178070, 6519416),
    (318930745, 6519416),
    (319219186, 6519416),
    (327690435, 6519416),
    (315952997, 6519416),
    (319191586, 6519416),
    (321400658, 6519416),
    (328796894, 6519416),
    (315758118, 6519416),
    (318960001, 6519416),
    (317526631, 6519416),
    (316489254, 6519416),
    (315287746, 6519416),
    (318547879, 6519416),
    (317940600, 6519416),
    (320129035, 6519416),
    (325044733, 6519416),
    (316804630, 6519416),
    (327478846, 6523060),
    (321603785, 6523060),
    (318771638, 6523060),
    (322468484, 6523060),
    (323544269, 6523060),
    (328024485, 6523060),
    (315472171, 6526863),
    (315732875, 6526863),
    (318121040, 6526863),
    (318155758, 6526863),
    (318116614, 6526863),
    (318595611, 6526863),
    (329355642, 6526863),
    (318930539, 6526863),
    (319075129, 6526863),
    (318771678, 6526863),
    (318140265, 6526863),
    (315333109, 6526863),
    (318471063, 6526863),
    (316609495, 6526863),
    (319219188, 6526863),
    (316314880, 6526863),
    (315914820, 6526863),
    (315332810, 6526863),
    (317886132, 6526863),
    (315472226, 6526863),
    (318595571, 6526863),
    (316543310, 6526863),
    (318138982, 6526863),
    (317267798, 6526863),
    (317267833, 6526863),
    (315931392, 6526863),
    (317886148, 6526863),
    (315331964, 6526863),
    (316735937, 6526863),
    (318595477, 6526863),
    (316539154, 6526863),
    (319624534, 6526863),
    (316536442, 6526863),
    (316314978, 6526863),
    (318752375, 6526863),
    (317886179, 6526863),
    (316787711, 6526863),
    (315730898, 6526863),
    (316698940, 6526863),
    (316176936, 6526863),
    (328873227, 6526863),
    (316176907, 6526863),
    (316177051, 6526863),
    (315332150, 6526863),
    (331014978, 6526863),
    (316176947, 6526863),
    (316698815, 6526863),
    (315731046, 6526863),
    (318929865, 6526863),
    (318003547, 6526863),
    (315730953, 6526863),
    (317267783, 6526863),
    (328873313, 6526863),
    (319618348, 6526863),
    (316699046, 6526863),
    (317639672, 6526863),
    (319603842, 6526863),
    (315462020, 6526863),
    (318329009, 6526863),
    (319074730, 6526863),
    (316176988, 6526863),
    (318003480, 6526863),
    (324180316, 6526863),
    (317845013, 6526863),
    (318003530, 6526863),
    (318003846, 6526863),
    (319191800, 6526863),
    (316698868, 6526863),
    (321866239, 6526863),
    (319393957, 6526863),
    (323806045, 6526863),
    (317920754, 6526863),
    (317885451, 6526863),
    (316500003, 6526863),
    (316502985, 6526863),
    (321393905, 6526863),
    (315152761, 6526863),
    (323806059, 6526863),
    (328007826, 6526863),
    (323818287, 6526863),
    (315758127, 6526863),
    (315546330, 6526863),
    (316638163, 6526863),
    (316594181, 6526863),
    (315509566, 6526863),
    (315865578, 6526863),
    (316801815, 6526863),
    (315449517, 6526863),
    (318764162, 6526863),
    (318799461, 6526863),
    (318799368, 6526863),
    (318300779, 6526863),
    (324608513, 6526863),
    (327980113, 6526863),
    (329139173, 6526863),
    (321658068, 6526863),
    (319409564, 6526863),
    (316684858, 6526863),
    (315616036, 6526863),
    (317154260, 6526863),
    (317135922, 6526863),
    (315311096, 6526863),
    (315320234, 6526863),
    (321856190, 6526863),
    (320867086, 6526863),
    (319088681, 6526863),
    (317932222, 6526863),
    (318799299, 6526863),
    (320496590, 6526863),
    (315449546, 6526863),
    (319048370, 6526863),
    (317893775, 6526863),
    (319571777, 6526863),
    (315460784, 6526863),
    (315871993, 6526863),
    (316598956, 6526863),
    (316663915, 6526863),
    (318317576, 6526863),
    (316628223, 6526863),
    (319839219, 6526870),
    (322468555, 6526870),
    (329742064, 6526870),
    (328024402, 6526870),
    (328024513, 6526870),
    (328024598, 6526870),
    (328601810, 6526870),
    (328024871, 6526870),
    (328018822, 6526870),
    (318310521, 6526870),
    (320683995, 6526870),
    (321823550, 6526870),
    (324540180, 6526870),
    (324449763, 6526889),
    (329140705, 6526889),
    (328014540, 6526889),
    (324605392, 6526889),
    (331693475, 6526889),
    (323939283, 6526889),
    (322468010, 6526889),
    (322455774, 6526889),
    (329922052, 6526889),
    (318470740, 6526889),
    (321659203, 6526889),
    (328024611, 6526889),
    (322812099, 6526889),
    (318595368, 6526889),
    (319056489, 6526889),
    (328601828, 6526889),
    (328024853, 6526889),
    (328601866, 6526889),
    (327464280, 6526889),
    (327687919, 6526889),
    (328024551, 6526889),
    (322811053, 6526889),
    (322809332, 6526889),
    (322811180, 6526889),
    (322809764, 6526889),
    (324181644, 6526889),
    (322258612, 6526889),
    (323544310, 6526889),
    (321400302, 6526889),
    (318328937, 6526889),
    (331015085, 6526889),
    (318328945, 6526889),
    (320764901, 6526889),
    (328025152, 6526889),
    (327684600, 6526889),
    (324183047, 6526889),
    (321603753, 6526889),
    (327464209, 6526889),
    (324180973, 6526889),
    (324180437, 6526889),
    (322468568, 6526889),
    (322258519, 6526889),
    (319597440, 6526889),
    (318328999, 6526889),
    (324628803, 6526889),
    (321424779, 6526889),
    (329169675, 6526889),
    (331014943, 6526889),
    (329301097, 6526889),
    (328601756, 6526889),
    (323544284, 6526889),
    (323544237, 6526889),
    (323544348, 6526889),
    (323544304, 6526889),
    (322468601, 6526889),
    (322258625, 6526889),
    (321866198, 6526889),
    (321424712, 6526889),
    (321659154, 6526889),
    (324628919, 6526889),
    (321865950, 6526889),
    (324181494, 6526889),
    (318929906, 6526889),
    (321603884, 6526889),
    (321866228, 6526889),
    (327873670, 6526889),
    (319837602, 6526889),
    (332123726, 6526889),
    (328024839, 6526889),
    (328601847, 6526889),
    (321424850, 6526889),
    (328601789, 6526889),
    (322258488, 6526889),
    (327686566, 6526889),
    (328024443, 6526889),
    (331954583, 6526889),
    (318595444, 6526889),
    (327687460, 6526889),
    (328024858, 6526889),
    (329742165, 6526889),
    (321424882, 6526889),
    (324180389, 6526889),
    (327984750, 6526889),
    (321603839, 6526889),
    (328024693, 6526889),
    (319128680, 6526889),
    (321866186, 6526889),
    (322468565, 6526889),
    (328218937, 6526889),
    (324178077, 6526889),
    (328601743, 6526889),
    (332075155, 6526889),
    (322822942, 6526889),
    (327475061, 6526889),
    (328524151, 6526889),
    (327876854, 6526889),
    (328026461, 6526889),
    (322810151, 6526889),
    (321774357, 6526889),
    (327464256, 6526889),
    (318470704, 6526889),
    (318741001, 6526889),
    (318328947, 6526889),
    (318470730, 6526889),
    (328024893, 6526889),
    (322812717, 6526889),
    (318470803, 6526889),
    (322468593, 6526889),
    (324182123, 6526889),
    (323544276, 6526889),
    (324182396, 6526889),
    (319023166, 6526889),
    (327688206, 6526889),
    (324628783, 6526889),
    (318329024, 6526889),
    (331684859, 6526889),
    (319056000, 6526889),
    (329301163, 6526889),
    (328233731, 6526889),
    (322468494, 6526889),
    (322468612, 6526889),
    (323544260, 6526889),
    (322258506, 6526889),
    (322810286, 6526889),
    (320764978, 6526889),
    (324180931, 6526889),
    (332082971, 6526889),
    (329922000, 6526889),
    (318595446, 6526889),
    (321866256, 6526889),
    (319055540, 6526889),
    (328602076, 6526889),
    (328601862, 6526889),
    (329742225, 6526889),
    (329742258, 6526889),
    (324183610, 6526889),
    (331015045, 6526889),
    (328218924, 6526889),
    (324449624, 6526889),
    (318470663, 6526889),
    (318451983, 6526889),
    (331699633, 6526889),
    (328011088, 6526889),
    (325218184, 6526889),
    (318218153, 6526889),
    (329285252, 6526889),
    (328004663, 6526889),
    (330981194, 6526889),
    (321832418, 6526889),
    (328009948, 6526889),
    (332076721, 6526889),
    (320139087, 6526889),
    (329847764, 6526889),
    (323876091, 6526889),
    (328194994, 6526889),
    (332066169, 6526889),
    (324449315, 6526889),
    (329352903, 6526889),
    (329257585, 6526889),
    (324399181, 6526889),
    (324625721, 6526889),
    (318813745, 6526889),
    (327658546, 6526889),
    (318300155, 6526889),
    (328844392, 6526889),
    (328867413, 6526889),
    (320139081, 6526889),
    (328563351, 6526889),
    (319044050, 6526889),
    (329134139, 6526889),
    (319733620, 6526889),
    (324448225, 6526889),
    (319049758, 6526889),
    (328979028, 6526889),
    (323825809, 6526889),
    (318445373, 6526889),
    (323828285, 6526889),
    (318582107, 6526889),
    (329291486, 6526889),
    (319045429, 6526889),
    (328058547, 6526889),
    (327611360, 6526889),
    (327544607, 6526889),
    (327864041, 6526889),
    (322150972, 6526889),
    (323835304, 6526889),
    (323887608, 6526889),
    (321665850, 6526889),
    (322117771, 6526889),
    (324415240, 6526889),
    (331954506, 6526889),
    (321833670, 6526889),
    (322663022, 6526889),
    (323883353, 6526889),
    (328008169, 6526889),
    (330864983, 6526889),
    (330998800, 6526889),
    (319017263, 6526889),
    (318802454, 6526889),
    (331929329, 6526889),
    (331696908, 6526889),
    (323461280, 6526889),
    (318058327, 6526889),
    (331624383, 6526889),
    (328977155, 6526889),
    (322162767, 6526889),
    (321658001, 6526889),
    (329134130, 6526889),
    (320751787, 6526889),
    (318241738, 6526889),
    (328009471, 6526889),
    (327549114, 6526889),
    (330981186, 6526889),
    (327635290, 6526889),
    (331705714, 6526889),
    (331690999, 6526889),
    (328058097, 6526889),
    (328011499, 6526889),
    (329575526, 6526889),
    (322120203, 6526889),
    (323835631, 6526889),
    (326047290, 6526889),
    (328152365, 6526889),
    (327865479, 6526889),
    (321782798, 6526889),
    (328977985, 6526889),
    (332080031, 6526889),
    (329299362, 6526889),
    (329295546, 6526889),
    (321837737, 6526889),
    (321381263, 6526889),
    (327622509, 6526889),
    (323824542, 6526889),
    (320737427, 6526889),
    (321366244, 6526889),
    (328978595, 6526889),
    (328978516, 6526889),
    (323826319, 6526889),
    (328578209, 6526889),
    (332123076, 6526889),
    (322669944, 6526889),
    (318792994, 6526889),
    (327844880, 6526889),
    (328572973, 6526889),
    (329641554, 6526889),
    (328567931, 6526889),
    (318443458, 6526889),
    (319156002, 6526889),
    (323940095, 6526889),
    (328011500, 6526889),
    (322256723, 6526889),
    (328978527, 6526889),
    (318222357, 6526889),
    (323812264, 6526889),
    (327583480, 6526889),
    (328010325, 6526889),
    (320727342, 6526889),
    (328563332, 6526889),
    (324610696, 6526889),
    (329297723, 6526889),
    (323836439, 6526889),
    (319156093, 6526889),
    (329908455, 6526889),
    (329138249, 6526889),
    (330965229, 6526889),
    (329353361, 6526889),
    (319186713, 6526889),
    (318289425, 6526889),
    (327462962, 6526889),
    (327966847, 6526889),
    (329916373, 6526889),
    (328808405, 6526889),
    (331704207, 6526889),
    (332122747, 6526889),
    (329799356, 6526889),
    (331001961, 6526889),
    (332070163, 6526889),
    (326814231, 6526889),
    (332079356, 6526889),
    (327873212, 6526889),
    (328574055, 6526889),
    (331935149, 6526889),
    (324405881, 6526889),
    (329640053, 6526889),
    (328016119, 6526889),
    (328843754, 6526889),
    (328581570, 6526889),
    (319009931, 6526889),
    (328523337, 6526889),
    (329262906, 6526889),
    (332081426, 6526889),
    (326452176, 6526889),
    (328581179, 6526889),
    (330819580, 6526889),
    (327966448, 6526889),
    (329300717, 6526889),
    (327618727, 6526889),
    (328559741, 6526889),
    (328601313, 6526889),
    (329150710, 6526889),
    (324406140, 6526889),
    (331942895, 6526889),
    (323467715, 6526889),
    (328006256, 6526889),
    (318368243, 6527559),
    (319075180, 6527559),
    (321774567, 6527559),
    (321774603, 6527559),
    (321774555, 6527559),
    (321774622, 6527559),
    (315737471, 6527559),
    (319057875, 6527559),
    (315975837, 6527559),
    (321611199, 6527559),
    (317257288, 6527559),
    (317267816, 6527559),
    (318771666, 6527559),
    (315737439, 6527559),
    (316314866, 6527559),
    (316614529, 6527559),
    (318471169, 6527559),
    (317029272, 6527559),
    (315940114, 6527559),
    (316314994, 6527559),
    (316455900, 6527559),
    (315155117, 6527559),
    (315735052, 6527559),
    (318140267, 6527559),
    (315737542, 6527559),
    (317046834, 6527559),
    (315333121, 6527559),
    (317750731, 6527559),
    (319024527, 6527559),
    (316543265, 6527559),
    (316314912, 6527559),
    (317416983, 6527559),
    (319151557, 6527559),
    (319075280, 6527559),
    (315497704, 6527559),
    (317750820, 6527559),
    (319024593, 6527559),
    (319624291, 6527559),
    (315732605, 6527559),
    (317863771, 6527559),
    (316607991, 6527559),
    (315471499, 6527559),
    (315497675, 6527559),
    (315471884, 6527559),
    (317750712, 6527559),
    (317886129, 6527559),
    (317046719, 6527559),
    (318595622, 6527559),
    (316971335, 6527559),
    (315737497, 6527559),
    (318004729, 6527559),
    (318595495, 6527559),
    (316752935, 6527559),
    (315975912, 6527559),
    (318930592, 6527559),
    (316198450, 6527559),
    (317046865, 6527559),
    (319024899, 6527559),
    (316543397, 6527559),
    (316629357, 6527559),
    (315737428, 6527559),
    (317046694, 6527559),
    (318344808, 6527559),
    (316614509, 6527559),
    (316543332, 6527559),
    (319075222, 6527559),
    (318005756, 6527559),
    (321425070, 6527559),
    (318005035, 6527559),
    (315466696, 6527559),
    (318930496, 6527559),
    (319219170, 6527559),
    (319625132, 6527559),
    (327987208, 6527559),
    (315331979, 6527559),
    (318349569, 6527559),
    (318930346, 6527559),
    (321605807, 6527559),
    (315332072, 6527559),
    (318771750, 6527559),
    (316629398, 6527559),
    (318471025, 6527559),
    (318930610, 6527559),
    (319192474, 6527559),
    (319024554, 6527559),
    (319024942, 6527559),
    (318367241, 6527559),
    (318471009, 6527559),
    (318930776, 6527559),
    (318752446, 6527559),
    (317850204, 6527559),
    (315730782, 6527559),
    (319613294, 6527559),
    (315923281, 6527559),
    (316931113, 6527559),
    (319056553, 6527559),
    (318771602, 6527559),
    (315731253, 6527559),
    (315733278, 6527559),
    (315736188, 6527559),
    (315331479, 6527559),
    (315331481, 6527559),
    (315731122, 6527559),
    (315155020, 6527559),
    (315968084, 6527559),
    (315913327, 6527559),
    (316699072, 6527559),
    (315731108, 6527559),
    (316176967, 6527559),
    (315731256, 6527559),
    (315731161, 6527559),
    (315731164, 6527559),
    (315731279, 6527559),
    (319611724, 6527559),
    (315731224, 6527559),
    (315730728, 6527559),
    (318930146, 6527559),
    (318003693, 6527559),
    (315730684, 6527559),
    (316176900, 6527559),
    (315731150, 6527559),
    (318003833, 6527559),
    (318003554, 6527559),
    (315730998, 6527559),
    (315730999, 6527559),
    (315731322, 6527559),
    (315731080, 6527559),
    (318929954, 6527559),
    (315731101, 6527559),
    (315496711, 6527559),
    (319022790, 6527559),
    (317389223, 6527559),
    (316176868, 6527559),
    (317267803, 6527559),
    (317203373, 6527559),
    (317267840, 6527559),
    (319056522, 6527559),
    (317845102, 6527559),
    (318741057, 6527559),
    (315731214, 6527559),
    (318930070, 6527559),
    (318740940, 6527559),
    (318470750, 6527559),
    (315730761, 6527559),
    (318003567, 6527559),
    (318003508, 6527559),
    (315161193, 6527559),
    (315730800, 6527559),
    (319618029, 6527559),
    (315331208, 6527559),
    (318109594, 6527559),
    (315731185, 6527559),
    (318109552, 6527559),
    (318329010, 6527559),
    (315730676, 6527559),
    (316513463, 6527559),
    (315155064, 6527559),
    (315913144, 6527559),
    (315730885, 6527559),
    (316513548, 6527559),
    (318003802, 6527559),
    (320528259, 6527559),
    (318771509, 6527559),
    (318329097, 6527559),
    (315731178, 6527559),
    (315731179, 6527559),
    (315732307, 6527559),
    (316629257, 6527559),
    (316629265, 6527559),
    (316513561, 6527559),
    (315975806, 6527559),
    (321866153, 6527559),
    (315730814, 6527559),
    (318003671, 6527559),
    (318003843, 6527559),
    (318003927, 6527559),
    (318109523, 6527559),
    (319618701, 6527559),
    (318003911, 6527559),
    (315913116, 6527559),
    (316930232, 6527559),
    (316466391, 6527559),
    (315622283, 6527559),
    (315615165, 6527559),
    (317928723, 6527559),
    (315614754, 6527559),
    (315617231, 6527559),
    (315615083, 6527559),
    (315623590, 6527559),
    (315622491, 6527559),
    (323869137, 6527559),
    (315506449, 6527559),
    (315433625, 6527559),
    (315622307, 6527559),
    (315615161, 6527559),
    (315614944, 6527559),
    (315577701, 6527559),
    (315565826, 6527559),
    (315619871, 6527559),
    (315618278, 6527559),
    (315577249, 6527559),
    (315622403, 6527559),
    (318082375, 6527559),
    (315622505, 6527559),
    (315619877, 6527559),
    (315630834, 6527559),
    (315618174, 6527559),
    (315614849, 6527559),
    (315618716, 6527559),
    (318445840, 6527559),
    (321196209, 6527559),
    (318799900, 6527559),
    (319087960, 6527559),
    (317894183, 6527559),
    (318302243, 6527559),
    (318029591, 6527559),
    (316690159, 6527559),
    (315525018, 6527559),
    (316638129, 6527559),
    (315524919, 6527559),
    (318575764, 6527559),
    (315521782, 6527559),
    (318558530, 6527559),
    (316433209, 6527559),
    (317894145, 6527559),
    (316628879, 6527559),
    (315152760, 6527559),
    (315913080, 6527559),
    (317923008, 6527559),
    (316667494, 6527559),
    (318058478, 6527559),
    (315504554, 6527559),
    (315616552, 6527559),
    (318960489, 6527559),
    (318735231, 6527559),
    (317178006, 6527559),
    (315458781, 6527559),
    (315150925, 6527559),
    (317378291, 6527559),
    (317378296, 6527559),
    (318776477, 6527559),
    (317629047, 6527559),
    (318219477, 6527559),
    (315878319, 6527559),
    (318259273, 6527559),
    (317639688, 6527559),
    (317885398, 6527559),
    (315137644, 6527559),
    (317367506, 6527559),
    (318085406, 6527559),
    (316571627, 6527559),
    (315489447, 6527559),
    (316686416, 6527559),
    (318794125, 6527559),
    (317629410, 6527559),
    (323835956, 6527559),
    (317922863, 6527559),
    (319067800, 6527559),
    (317927088, 6527559),
    (315324608, 6527559),
    (318735715, 6527559),
    (316882148, 6527559),
    (315489671, 6527559),
    (316802442, 6527559),
    (315484138, 6527559),
    (315861601, 6527559),
    (315616437, 6527559),
    (319046471, 6527559),
    (315509346, 6527559),
    (318806081, 6527559),
    (315504279, 6527559),
    (317894993, 6527559),
    (317325408, 6527559),
    (315613206, 6527559),
    (315489740, 6527559),
    (315137314, 6527559),
    (316428242, 6527559),
    (315496391, 6527559),
    (315278806, 6527559),
    (318310577, 6527559),
    (317930611, 6527559),
    (316663629, 6527559),
    (318449645, 6527559),
    (319398509, 6527559),
    (316690682, 6527559),
    (315523806, 6527559),
    (317371152, 6527559),
    (315875524, 6527559),
    (318726324, 6527559),
    (317893583, 6527559),
    (315484222, 6527559),
    (316500949, 6527559),
    (318571235, 6527559),
    (319402233, 6527559),
    (319018612, 6527559),
    (317844242, 6527559),
    (316504985, 6527559),
    (318571639, 6527559),
    (317158164, 6527559),
    (318809941, 6527559),
    (317135930, 6527559),
    (318310507, 6527559),
    (316666102, 6527559),
    (318452832, 6527559),
    (317639642, 6527559),
    (316457485, 6527559),
    (315451461, 6527559),
    (315484218, 6527559),
    (316494839, 6527559),
    (318409539, 6527559),
    (319065836, 6527559),
    (315523450, 6527559),
    (315865777, 6527559),
    (316617137, 6527559),
    (318448529, 6527559),
    (315622289, 6527559),
    (315520054, 6527559),
    (319034891, 6527559),
    (315507124, 6527559),
    (315525612, 6527559),
    (315614040, 6527559),
    (318583242, 6527559),
    (318772985, 6527559),
    (319008045, 6527559),
    (324365174, 6527559),
    (317893777, 6527559),
    (318811822, 6527559),
    (316662471, 6527559),
    (319033714, 6527559),
    (317885267, 6527559),
    (317173320, 6527559),
    (315459288, 6527559),
    (319090188, 6527559),
    (318299756, 6527559),
    (316096033, 6527559),
    (316881900, 6527559),
    (318771303, 6527559),
    (317367291, 6527559),
    (321691371, 6527559),
    (315453857, 6527559),
    (318587822, 6527559),
    (318574126, 6527559),
    (317932209, 6527559),
    (318815381, 6527559),
    (315884859, 6527559),
    (316506200, 6527559),
    (319785738, 6527559),
    (318317575, 6527559),
    (318586435, 6527559),
    (319089816, 6527559),
    (319038895, 6527559),
    (317923995, 6527559),
    (317836764, 6527559),
    (318786962, 6527559),
    (315310422, 6527559),
    # Unlink
    (318929623, None),
    (316434862, None),
    (324179101, None),
    (315497657, None),
    (315332679, None),
    (317923002, None),
    (323468537, None),
    (324178078, None),
    (321774447, None),
    (319597470, None),
    (321866139, None),
    (321866140, None),
    (315331104, None),
    (329301019, None),
    (318109512, None),
    (315731061, None),
    (315913650, None),
    (319217756, None),
    (321866258, None),
    (321866146, None),
    (316435050, None),
    (323544287, None),
    (319055789, None),
    (316698808, None),
    (319838178, None),
    (318329008, None),
    (315913157, None),
    (329169771, None),
    (315154388, None),
    (315913291, None),
    (316698996, None),
    (321866147, None),
    (322258536, None),
    (319835407, None),
    (321866141, None),
    (315730726, None),
    (319022615, None),
    (321424685, None),
    (315462034, None),
    (317750840, None),
    (315330998, None),
    (321424756, None),
    (316930270, None),
    (320521614, None),
    (318595403, None),
    (319074733, None),
    (316435027, None),
    (319191593, None),
    (322258547, None),
    (328602101, None),
    (316176918, None),
    (321424842, None),
]


def main() -> None:
    for offer_product_pair in _OFFERS_TO_PRODUCTS_MAPPING:
        offer_id, product_id = offer_product_pair

        offer: offers_models.Offer | None = db.session.query(offers_models.Offer).filter_by(id=offer_id).one_or_none()
        if not offer:
            logger.warning(f"Offer #{offer_id} does not exist")  # should not happen
            continue

        # Case 1 : Unlink
        if product_id is None:
            if offer.product:
                logger.info(
                    "Offer is going to be unlinked from product",
                    extra={
                        "offer": {"id": offer.id, "name": offer.name},
                        "product": {"id": offer.product.id, "name": offer.product.name},
                    },
                )
                offer.product = None
                on_commit(
                    partial(
                        search.async_index_offer_ids,
                        [offer.id],
                        reason=search.IndexationReason.OFFER_UPDATE,
                        log_extra={},
                    )
                )
                db.session.flush()
                continue

        # Case 2 : Link to different product
        product = db.session.query(offers_models.Product).filter_by(id=product_id).one_or_none()
        if not product:
            logger.warning(f"Product #{product_id} does not exist")  # should not happen
            continue

        if product.id == offer.productId:
            logger.info(f"Offer #{offer_id} already linked to product #{product_id}")  # to make script idempotent
            continue

        logger.info(
            "Offer is going to be linked to a different product",
            extra={
                "offer": {
                    "id": offer.id,
                    "name": offer.name,
                },
                "product": {
                    "before": {
                        "id": offer.product.id if offer.product else "",
                        "name": offer.product.name if offer.product else "",
                    },
                    "after": {
                        "id": product.id,
                        "name": product.name,
                    },
                },
            },
        )
        offer.product = product
        on_commit(
            partial(
                search.async_index_offer_ids,
                [offer.id],
                reason=search.IndexationReason.OFFER_UPDATE,
                log_extra={},
            )
        )
        db.session.flush()


if __name__ == "__main__":
    app.app_context().push()

    parser = argparse.ArgumentParser()
    parser.add_argument("--not-dry", action="store_true")
    args = parser.parse_args()

    main()

    if args.not_dry:
        logger.info("Finished")
        db.session.commit()
    else:
        logger.info("Finished dry run, rollback")
        db.session.rollback()
