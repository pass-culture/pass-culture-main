{% extends "layouts/details.html" %}
{% import "components/badges.html" as badges with context %}
{% import "components/links.html" as links with context %}
{% import "components/clipboard.html" as clipboard %}
{% import "components/logo.html" as logo %}
{% from "components/connect_as.html" import build_connect_as %}
{% from "components/turbo/lazy_modal.html" import build_lazy_modal with context %}
{% from "components/generic_modal.html" import build_simple_modal_form with context %}
{% from "products/titelive_information.html" import render_titelive_information %}
{% block title %}{{ product.name }}{% endblock %}
{% block header_extra %}
<div>
    {% call badges.badges_container() %}
    {% if product.lastProviderId %}{{ product.lastProvider.name | format_badge("primary") }}{% endif %}
    {{ product.gcuCompatibilityType | format_product_cgu_compatibility_status(provider_name, with_badge=True) }}
    {% endcall %}
</div>
{% endblock %}
{% block action_buttons %}
{% if action.SYNCHRO_TITELIVE in allowed_actions.inline_actions and product.ean %}
{{ action_bar_button("arrow-repeat", "Synchronisation Titelive", modal_id="#synchro-product-modal-" + product.id|string) }}
{% endif %}
{% if action.WHITELIST in allowed_actions.inline_actions and product.gcuCompatibilityType.value != "COMPATIBLE" %}
{{ action_bar_button("check-circle", "Whitelist", modal_id="#whitelist-product-modal-" + product.id|string) }}
{% endif %}
{% if action.BLACKLIST in allowed_actions.inline_actions and product.gcuCompatibilityType.value == "COMPATIBLE" %}
{{ action_bar_button("x-circle", "Blacklist", modal_id="#blacklist-product-modal-" + product.id|string) }}
{% endif %}
<!-- ADDITIONAL BUTTONS TO PUT IN DROPDOWN MENU -->
{% if allowed_actions.additional_actions %}
<ul class="dropdown-menu">
    {% if action.SYNCHRO_TITELIVE in allowed_actions.additional_actions %}
    <li>
        {{ action_bar_additional_button("arrow-repeat", "Synchronisation Titelive", modal_id="#synchro-product-modal-" +
        product.id|string) }}
    </li>
    {% endif %}
    {% if action.WHITELIST in allowed_actions.additional_actions %}
    <li>
        {{ action_bar_additional_button("check-circle", "Whitelist", modal_id="#whitelist-product-modal-" +
        product.id|string) }}
    </li>
    {% endif %}
    {% if action.BLACKLIST in allowed_actions.additional_actions %}
    <li>
        {{ action_bar_additional_button("x-circle", "Blacklist", modal_id="#blacklist-product-modal-" +
        product.id|string) }}
    </li>
    {% endif %}
</ul>
<button type="button"
        class="btn btn-outline-primary-subtle-bg d-flex gap-2"
        data-bs-toggle="dropdown">
    Plus d'actions
    <i class="bi bi-three-dots-vertical"></i>
</button>
{% endif %}
{% endblock action_buttons %}
{% block details_container %}
{% call details_content_wrapper("product-details") %}
<!-- INFO -->
{% call nav_section("info", "Détails du produit") %}
<div class="d-flex gap-1">
    <div class="flex-grow-1">
        {% if product.ean or product.extraData.visa or product.extraData.allocineId %}
        <h5>Informations techniques</h5>
        {% if product.ean %}
        {% call description_detail_horizontal("EAN") %}
        {{ product.ean }}
        {{ clipboard.copy_to_clipboard(product.ean, "Copier") }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.visa %}
        {% call description_detail_horizontal("Visa") %}
        {{ product.extraData.visa }}
        {{ clipboard.copy_to_clipboard(product.extraData.visa, "Copier") }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.allocineId %}
        {% call description_detail_horizontal("Allocine ID") %}
        {{ product.extraData.allocineId }}
        {{ clipboard.copy_to_clipboard(product.extraData.allocineId, "Copier") }}
        {% endcall %}
        {% endif %}
        {% endif %}
        <h5>Informations artistiques</h5>
        {% if product.extraData.author %}
        {% call description_detail_horizontal("Auteur") %}
        {{ product.extraData.author }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.editeur %}
        {% call description_detail_horizontal("Éditeur") %}
        {{ product.extraData.editeur }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.performer %}
        {% call description_detail_horizontal("Interprète") %}
        {{ product.extraData.performer }}
        {% endcall %}
        {% endif %}
        {% if product.durationMinutes %}
        {% call description_detail_horizontal("Durée") %}
        {{ product.durationMinutes }} minutes
        {% endcall %}
        {% endif %}
        {% if product.extraData.diffusionVersion %}
        {% call description_detail_horizontal("Langue") %}
        {{ product.extraData.diffusionVersion }}
        {% endcall %}
        {% endif %}
        {% call description_detail_horizontal("Description") %}
        {{ product.description | empty_string_if_null | nl2br }}
        {% endcall %}
    </div>
    <div class="flex-shrink-1">
        {% if product.images["recto"] %}
        <figure class="figure">
            <div class="d-flex justify-content-center align-items-center">
                <object class="d-block offer-image"
                        data="{{ product.images['recto'] }}"
                        type="image/jpeg">
                    <div class="d-flex bg-secondary-subtle justify-content-center align-items-center product-no-image">
                        <i class="bi bi-file-image fs-2"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           data-bs-title="Image invalide"></i>
                    </div>
                </object>
            </div>
            <figcaption class="figure-caption">
                Crédits&nbsp;:
                Non renseigné
            </figcaption>
        </figure>
        {% else %}
        <div class="d-flex bg-secondary-subtle justify-content-center align-items-center product-no-image">
            <i class="bi bi-file-image fs-2"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               data-bs-title="Pas d'image"></i>
        </div>
        {% endif %}
    </div>
</div>
{% endcall %}
{# section info #}

<ul class="nav nav-tabs mb-3" id="offersTab" role="tablist">
    {% if product.ean %}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="titelive-tab" data-bs-toggle="tab" data-bs-target="#titelive-data"
                    type="button" role="tab">Information Titelive
            </button>
        </li>
    {% endif %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="linked-tab" data-bs-toggle="tab" data-bs-target="#linked-offers" type="button"
                role="tab">Offres liées
        </button>
    </li>
    {% if unlinked_offers %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="unlinked-tab" data-bs-toggle="tab" data-bs-target="#unlinked-offers" type="button"
                role="tab">Offres non liées
        </button>
    </li>
    {% endif %}
</ul>
<div class="tab-content" id="offersTabContent">

    {% if product.ean %}
        <div class="tab-pane fade show active" id="titelive-data" role="tabpanel">

            {% if titelive_data %}
                {{ render_titelive_information(titelive_data, ineligibility_reason, product_whitelist) }}
            {% endif %}
        </div>
        <div class="tab-pane fade" id="linked-offers" role="tabpanel">
    {% else %}
        <div class="tab-pane fade show active" id="linked-offers" role="tabpanel">
    {% endif %}
        <p class="lead num-results">
            {{ product_offers | length }}
            résultat{{ product_offers | length | pluralize }}
        </p>
        <table id="offers-table"
               class="table table-borderless table-hover">
            <thead class="table-light">
            <tr class="table-secondary fs-7">
                <th>ID</th>
                <th>Nom</th>
                <th>Partenaire culturel</th>
                <th>Status</th>
                <th>Date de création</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div id="linked-offers-pagination" class="pagination"></div>

        <style>
            .pagination {
              margin-top: 20px;
            }

            .pagination a.page-link {
              margin: 0 3px;
              text-decoration: none;
              padding: 4px 8px;
              border: none;
              background: none;
              font-weight: normal;
              cursor: pointer;
            }

            .pagination a.page-link.active {
              font-weight: bold;
              color: black;
              text-decoration: underline;
            }

            .pagination button {
              margin-left: 10px;
              padding: 4px 10px;
              cursor: pointer;
            }
        </style>
        <script>
            function initPaginatedTable({ data, tableSelector, paginationSelector, itemsPerPage = 20, rowRenderer }) {
              let currentPage = 1;

              function displayPage(page) {
                const totalPages = Math.ceil(data.length / itemsPerPage);
                if (page < 1 || page > totalPages) return;

                currentPage = page;
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageData = data.slice(startIndex, endIndex);

                const tbody = document.querySelector(`${tableSelector} tbody`);
                if (!tbody) return;
                tbody.innerHTML = '';

                pageData.forEach(item => {
                  const row = document.createElement('tr');
                  row.innerHTML = rowRenderer(item);
                  tbody.appendChild(row);
                });

                updatePagination();
              }

              function updatePagination() {
                const totalPages = Math.ceil(data.length / itemsPerPage);
                const paginationDiv = document.querySelector(paginationSelector);
                if (!paginationDiv) return;
                paginationDiv.innerHTML = '';

                const maxPagesToShow = 20;
                let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = startPage + maxPagesToShow - 1;

                if (endPage > totalPages) {
                  endPage = totalPages;
                  startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                if (currentPage > 1) {
                  const prevBtn = document.createElement('a');
                  prevBtn.href = '#';
                  prevBtn.textContent = 'Précédent';
                  prevBtn.classList.add('pagination-text-link');
                  prevBtn.onclick = () => displayPage(currentPage - 1);
                  paginationDiv.appendChild(prevBtn);
                }

                for (let i = startPage; i <= endPage; i++) {
                  const pageLink = document.createElement('a');
                  pageLink.href = '#';
                  pageLink.textContent = i;
                  pageLink.classList.add('page-link');
                  if (i === currentPage) pageLink.classList.add('active');
                  pageLink.addEventListener('click', e => {
                    e.preventDefault();
                    displayPage(i);
                  });
                  paginationDiv.appendChild(pageLink);
                }

                if (currentPage < totalPages) {
                  const nextBtn = document.createElement('a');
                  nextBtn.href = '#';
                  nextBtn.textContent = 'Suivant';
                  nextBtn.classList.add('pagination-text-link');
                  nextBtn.onclick = () => displayPage(currentPage + 1);
                  paginationDiv.appendChild(nextBtn);
                }
              }

              displayPage(1);
            }
        </script>
        <script>
            const offers = {{ product_offers | tojson }};
            initPaginatedTable({
              data: offers,
              tableSelector: '#offers-table',
              paginationSelector: '#linked-offers-pagination',
              itemsPerPage: 20,
              rowRenderer: offer => `
                <td><a href="/pro/offer/${offer.id}" class="link-primary">${offer.id}</a></td>
                <td>${offer.name}</td>
                <td>
                  <a href="/pro/venue/${offer.venue_id}" class="link-primary" data-bs-toggle="tooltip"
                  data-bs-placement="top" data-bs-title="Voir le partenaire culturel" target="_top">${offer.venue_name}</a>
                </td>
                <td>${offer.status}</td>
                <td>${offer.dateCreated}</td>
              `
            });
        </script>
    </div>
    {% if unlinked_offers %}
    <div class="tab-pane fade" id="unlinked-offers" role="tabpanel">
        <p class="lead num-results">
            {{ unlinked_offers | length }}
            résultat{{ unlinked_offers | length | pluralize }}
        </p>
        <div class="btn-group btn-group-sm"
             data-toggle="pc-batch-confirm-btn-group"
             data-toggle-id="table-link-offer-to-product-btn-group"
             data-pc-table-multi-select-id="table-link-offer-to-product-validation"
             data-input-ids-name="object_ids">
            <button disabled
                    type="button"
                    class="btn btn-outline-primary"
                    data-use-confirmation-modal="true"
                    data-mode="fetch"
                    data-fetch-url="{{ url_for('backoffice_web.product.confirm_link_offers_forms', product_id=product.id) }}"
                    data-modal-selector="#batch-link-to-product-modal">Associer les offres au produit
            </button>
        </div>
        <table id="unlinked-offers-table"
               class="table table-borderless table-hover"
               data-table-multi-select-id="table-link-offer-to-product-validation">
            <thead class="table-light">
            <tr class="table-secondary fs-7">
                <th scope="col">
                    <input type="checkbox"
                           class="form-check-input"
                           name="pc-table-multi-select-check-all"/>
                </th>
                <th>ID</th>
                <th>Nom</th>
                <th>Partenaire culturel</th>
                <th>Status</th>
                <th>Date de création</th>
            </tr>
            </thead>
            <tbody id="offres-non-liees">
            </tbody>
        </table>
        <div id="unlinked-offers-pagination" class="pagination"></div>
        {{ build_lazy_modal(url_for("backoffice_web.product.confirm_link_offers_forms", product_id=product.id) ,
        "batch-link-to-product-modal", "true") }}
        <script>
            const unlinked_offers = {{ unlinked_offers | tojson }};
            initPaginatedTable({
              data: unlinked_offers,
              tableSelector: '#unlinked-offers-table',
              paginationSelector: '#unlinked-offers-pagination',
              itemsPerPage: 20,
              rowRenderer: offer => `
                <td>
                  <input type="checkbox"
                   class="form-check-input"
                   name="pc-table-multi-select-check-${offer.id}"
                   data-id="${offer.id}" />
                </td>
                <td><a href="/pro/offer/${offer.id}" class="link-primary">${offer.id}</a></td>
                <td>${offer.name}</td>
                <td>
                  <a href="/pro/venue/${offer.venue_id}" class="link-primary" data-bs-toggle="tooltip"
                  data-bs-placement="top" data-bs-title="Voir le partenaire culturel" target="_top">${offer.venue_name}</a>
                </td>
                <td>${offer.status}</td>
                <td>${offer.dateCreated}</td>
              `
            });
        </script>
    </div>
    {% endif %}
</div>
{% endcall %}
{% endblock details_container %}
{% block side_column %}
<!-- BUTTONS -->
<div>
    {% call description_detail_vertical("Product ID") %}
    {{ product.id }}
    {{ clipboard.copy_to_clipboard(product.id, "Copier") }}
    {% endcall %}
    {% call description_detail_vertical("Catégorie") %}
    {{ product.subcategoryId | format_offer_category }}
    {% endcall %}
    {% call description_detail_vertical("Sous-catégorie") %}
    {{ product.subcategoryId | format_offer_subcategory }}
    {% endcall %}
    {% set extra_data = product.extraData %}
    {% if extra_data.gtl_id %}
    {% call description_detail_vertical("Type de musique") %}
    {{ extra_data.gtl_id | format_music_gtl_id }}
    {% endcall %}
    {% endif %}
    {% if extra_data.showType or extra_data.showSubType %}
    {% call description_detail_vertical("Type de spectacle") %}
    {{ extra_data.showType | format_show_type }} - {{ extra_data.showSubType | format_show_subtype }}
    {% endcall %}
    {% endif %}
    {% if extra_data.genres %}
    {% call description_detail_vertical("Genres") %}
    {{ extra_data.genres | format_string_list }}
    {% endcall %}
    {% endif %}
    <hr/>
    {% call description_detail_vertical("Nombre d'offres associées") %}
    {{ product_offers | length }}
    {% endcall %}
    {% call description_detail_vertical("Approuvées actives") %}
    {{ approved_active_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Approuvées inactives") %}
    {{ approved_inactive_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("En attente") %}
    {{ pending_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Rejetées") %}
    {{ rejected_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Offres non liées") %}
    {{ unlinked_offers | length }}
    {% endcall %}
</div>
{% endblock side_column %}
{% block extra_main_content %}
<!-- HIDDEN FORMS/AND MODALS -->
{% if action.SYNCHRO_TITELIVE in allowed_actions %}
{{ build_lazy_modal(url_for('backoffice_web.product.get_product_synchro_with_titelive_form', product_id=product.id) , "synchro-product-modal-" + product.id|string) }}
{% endif %}
{% if action.WHITELIST in allowed_actions %}
{{ build_lazy_modal(url_for('backoffice_web.product.get_product_whitelist_form', product_id=product.id) , "whitelist-product-modal-" + product.id|string) }}
{% endif %}
{% if action.BLACKLIST in allowed_actions %}
{{ build_lazy_modal(url_for('backoffice_web.product.get_product_blacklist_form', product_id=product.id) , "blacklist-product-modal-" + product.id|string) }}
{% endif %}
{% endblock extra_main_content %}
