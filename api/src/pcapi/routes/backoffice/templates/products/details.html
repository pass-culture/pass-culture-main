{% extends "layouts/details.html" %}
{% import "components/badges.html" as badges with context %}
{% import "components/links.html" as links with context %}
{% import "components/clipboard.html" as clipboard %}
{% import "components/logo.html" as logo %}
{% from "components/connect_as.html" import build_connect_as %}
{% from "components/turbo/lazy_modal.html" import build_lazy_modal with context %}
{% from "components/generic_modal.html" import build_simple_modal_form with context %}

{% block title %}{{ product.name }}{% endblock %}
{% block header_extra %}
<div>
    {% call badges.badges_container() %}
    {% if product.lastProviderId %}{{ product.lastProvider.name | format_badge("primary") }}{% endif %}
    {{ product.gcuCompatibilityType | format_product_cgu_compatibility_status(provider_name, with_badge=True) }}
    {% endcall %}
</div>
{% endblock %}


{% block action_buttons %}
{% if action.WHITELIST in allowed_actions.inline_actions %}
{{ action_bar_button("arrow-repeat", "Synchronisation Titelive", modal_id="#synchro-product-modal-" + product.id|string) }}
{% endif %}
{% if action.BLACKLIST in allowed_actions.inline_actions %}
{{ action_bar_button("x-circle", "Blacklist", modal_id="#blacklist-product-modal-" + product.id|string) }}
{% endif %}
<!-- ADDITIONAL BUTTONS TO PUT IN DROPDOWN MENU -->
{% if allowed_actions.additional_actions %}
<ul class="dropdown-menu">
    {% if action.WHITELIST in allowed_actions.additional_actions %}
    <li>{{ action_bar_additional_button("arrow-repeat", "Synchronisation Titelive", modal_id="#synchro-product-modal-" +
        product.id|string) }}
    </li>
    {% endif %}
    {% if action.BLACKLIST in allowed_actions.additional_actions %}
    <li>{{ action_bar_additional_button("x-circle", "Blacklist", modal_id="#blacklist-product-modal-" +
        product.id|string) }}
    </li>
    {% endif %}
</ul>
<button type="button"
        class="btn btn-outline-primary-subtle-bg d-flex gap-2"
        data-bs-toggle="dropdown">
    Plus d'actions
    <i class="bi bi-three-dots-vertical"></i>
</button>
{% endif %}
{% endblock action_buttons %}


{% block extra_title_bar %}
{% call content_navbar("product-details") %}
{{ content_navbar_element('info', 'Détails') }}
{{ content_navbar_element('offres', 'Offres') }}
{{ content_navbar_element('offres non liées', 'Offres non lié') }}
{% endcall %}
{% endblock extra_title_bar %}


{% block details_container %}
{% call details_content_wrapper("product-details") %}
<!-- INFO -->
{% call nav_section("info", "Détails du produit") %}
<div class="d-flex gap-1">
    <div class="flex-grow-1">
        {% if product.ean %}
        <h5>Informations techniques</h5>
        {% if product.ean %}
        {% call description_detail_horizontal("EAN") %}
        {{ product.ean }}
        {{ clipboard.copy_to_clipboard(product.ean, "Copier") }}
        {% endcall %}
        {% endif %}
        {% endif %}
        <h5>Informations artistiques</h5>
        {% if product.extraData.author %}
        {% call description_detail_horizontal("Auteur") %}
        {{ product.extraData.author }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.editeur %}
        {% call description_detail_horizontal("Éditeur") %}
        {{ product.extraData.editeur }}
        {% endcall %}
        {% endif %}
        {% if product.extraData.performer %}
        {% call description_detail_horizontal("Interprète") %}
        {{ product.extraData.performer }}
        {% endcall %}
        {% endif %}
        {% if product.durationMinutes %}
        {% call description_detail_horizontal("Durée") %}
        {{ product.durationMinutes }} minutes
        {% endcall %}
        {% endif %}
        {% if product.extraData.diffusionVersion %}
        {% call description_detail_horizontal("Langue") %}
        {{ product.extraData.diffusionVersion }}
        {% endcall %}
        {% endif %}
        {% call description_detail_horizontal("Description") %}
        {{ product.description | empty_string_if_null | nl2br }}
        {% endcall %}
    </div>
    <div class="flex-shrink-1">
        {% if product.images["recto"] %}
        <figure class="figure">
            <div class="d-flex justify-content-center align-items-center">
                <object class="d-block offer-image"
                        data="{{ product.images['recto'] }}"
                        type="image/jpeg">
                    <div class="d-flex bg-secondary-subtle justify-content-center align-items-center product-no-image">
                        <i class="bi bi-file-image fs-2"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           data-bs-title="Image invalide"></i>
                    </div>
                </object>
            </div>
            <figcaption class="figure-caption">
                Crédits&nbsp;:
                Non renseigné
            </figcaption>
        </figure>
        {% else %}
        <div class="d-flex bg-secondary-subtle justify-content-center align-items-center product-no-image">
            <i class="bi bi-file-image fs-2"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               data-bs-title="Pas d'image"></i>
        </div>
        {% endif %}
    </div>
</div>
{% endcall %}
{# section info #}
{% call nav_section("offres", "Offers") %}
<table class="table table-borderless table-hover">
    <thead class="table-light">
    <tr class="table-secondary fs-7">
        <th>ID</th>
        <th>Nom</th>
        <th>Status</th>
        <th>Date de création</th>
    </tr>
    </thead>
    <tbody>
    {% for offer in product.offers | sort(attribute="id", reverse=True) | sort(attribute="dateCreated", reverse=True) %}
    <tr>
        <td>{{ links.build_offer_details_link(offer) }}</td>
        <td>{{ offer.name }}</td>
        <td>{{ offer.status | format_offer_status }}</td>
        <td>{{ offer.dateCreated | format_date_time }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endcall %}

{% call nav_section("offres non liées", "Offers non lié") %}
<table class="table table-borderless table-hover">
    <thead class="table-light">
    <tr class="table-secondary fs-7">
        <th>ID</th>
        <th>Nom</th>
        <th>Status</th>
        <th>Date de création</th>
    </tr>
    </thead>
    <tbody id="offres-non-liees">
    {% for offer in offer_not_linked | sort(attribute="id", reverse=True) | sort(attribute="dateCreated", reverse=True) %}
    <tr>
        <td>{{ links.build_offer_details_link(offer) }}</td>
        <td>{{ offer.name }}</td>
        <td>{{ offer.status | format_offer_status }}</td>
        <td>{{ offer.dateCreated | format_date_time }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
    <!-- je sais pas ce que je fait du CSS -->
    <style>
        .pagination a {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
        .pagination .active {
            font-weight: bold;
        }
    </style>
    <div class="pagination">
        <!-- Lien vers la page précédente -->
        {% if page > 1 %}
            <a href="{{ url_for('.get_product_details', product_id=product.id, page=page-1, per_page=per_page) }}#offres-non-liees">Précédent</a>
        {% endif %}

        <!-- Affichage des pages -->
        {% for p in range(1, total_pages + 1) %}
            <a href="{{ url_for('.get_product_details', product_id=product.id, page=p, per_page=per_page) }}#offres-non-liees" class="{% if p == page %}active{% endif %}">{{ p }}</a>
        {% endfor %}

        <!-- Lien vers la page suivante -->
        {% if page < total_pages %}
            <a href="{{ url_for('.get_product_details', product_id=product.id, page=page+1, per_page=per_page) }}#offres-non-liees">Suivant</a>
        {% endif %}
    </div>
{% endcall %}

{% endcall %}
{% endblock details_container %}


{% block side_column %}
<!-- BUTTONS -->
<div>
    {% call description_detail_vertical("Product ID") %}
    {{ product.id }}
    {{ clipboard.copy_to_clipboard(product.id, "Copier") }}
    {% endcall %}
    {% call description_detail_vertical("Catégorie") %}
    {{ product.subcategoryId | format_offer_category }}
    {% endcall %}
    {% call description_detail_vertical("Sous-catégorie") %}
    {{ product.subcategoryId | format_offer_subcategory }}
    {% endcall %}
    {% set extra_data = product.extraData %}
    {% if extra_data.gtl_id %}
    {% call description_detail_vertical("Type de musique") %}
    {{ extra_data.gtl_id | format_music_gtl_id }}
    {% endcall %}
    {% endif %}
    {% if extra_data.showType or extra_data.showSubType %}
    {% call description_detail_vertical("Type de spectacle") %}
    {{ extra_data.showType | format_show_type }} - {{ extra_data.showSubType | format_show_subtype }}
    {% endcall %}
    {% endif %}
    {% if extra_data.genres %}
    {% call description_detail_vertical("Genres") %}
    {{ extra_data.genres | format_string_list }}
    {% endcall %}
    {% endif %}
    <hr/>
    {% call description_detail_vertical("Nombre d'offres associées") %}
        {{ offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Approuvées actives") %}
    {{ approved_active_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Approuvées inactives") %}
    {{ approved_inactive_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("En attente") %}
    {{ pending_offers_count }}
    {% endcall %}
    {% call description_detail_vertical("Rejetées") %}
    {{ rejected_offers_count }}
    {% endcall %}

</div>
{% endblock side_column %}


{% block extra_main_content %}
<!-- HIDDEN FORMS/AND MODALS -->
{% if action.WHITELIST in allowed_actions %}
{{ build_lazy_modal(url_for('backoffice_web.product.get_product_synchro_with_titelive_form', product_id=product.id) , "synchro-product-modal-" + product.id|string) }}
{% endif %}
{% if action.BLACKLIST in allowed_actions %}
{{ build_lazy_modal(url_for('backoffice_web.product.get_product_blacklist_form', product_id=product.id) , "blacklist-product-modal-" + product.id|string) }}
{% endif %}
{% endblock extra_main_content %}
