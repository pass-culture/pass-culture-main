{% import "components/forms.html" as forms with context %}
{% import "components/links.html" as links %}
{% extends "layouts/connected.html" %}
{% block page %}
  <div class="pt-3 px-5">
    {% set procedure_id = get_setting("DS_USER_ACCOUNT_UPDATE_PROCEDURE_ID") %}
    {% set link = "https://www.demarches-simplifiees.fr/procedures/" + procedure_id|string %}
    <h2 class="fw-light">
      Demandes de modifications – démarche <a href="{{ link }}"
    class="link-primary"
    target="_blank"
    title="Ouvrir la démarche DS">{{ procedure_id }} <i class="bi bi-box-arrow-up-right"></i></a>
    </h2>
    <div class="filters-container">{{ forms.build_filters_form(form, dst) }}</div>
    <div>
      {% if rows and rows.total > 0 %}
        <div class="d-flex justify-content-between">
          <p class="lead num-results">{{ rows.total }} dossier{{ rows.total | pluralize }}</p>
          <div>{% include "components/search/pagination.html" %}</div>
        </div>
        <table class="table mb-4">
          <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Dossier</th>
              <th scope="col">État</th>
              <th scope="col">Date de dernière MàJ</th>
              <th scope="col">Date des derniers messages</th>
              <th scope="col">Demandeur</th>
              <th scope="col">Jeune</th>
              <th scope="col">Modification</th>
              <th scope="col">Instructeur</th>
            </tr>
          </thead>
          <tbody>
            {% for update_request in rows.items %}
              <tr>
                <td></td>
                <td>
                  {% set link = "https://www.demarches-simplifiees.fr/dossiers/" + update_request.dsApplicationId|string %}
                  <a href="{{ link }}"
                     class="link-primary"
                     target="_blank"
                     title="Ouvrir le dossier DS">{{ update_request.dsApplicationId }} <i class="bi bi-box-arrow-up-right"></i></a>
                </td>
                <td>{{ update_request.status | format_dms_application_status_badge }}</td>
                <td>{{ update_request.dateLastStatusUpdate | format_date_time }}</td>
                <td>
                  {% if update_request.dateLastUserMessage %}
                    <span class="fw-bold">Demandeur :</span>
                    <br />
                    {{ update_request.dateLastUserMessage | format_date_time }}
                    <br />
                  {% endif %}
                  {% if update_request.dateLastInstructorMessage %}
                    <span class="fw-bold">Instructeur :</span>
                    <br />
                    {{ update_request.dateLastInstructorMessage | format_date_time }}
                    <br />
                  {% endif %}
                </td>
                <td>
                  {{ update_request.firstName | empty_string_if_null }} {{ update_request.lastName | empty_string_if_null }}
                  {% if update_request.birthDate %}
                    <br />
                    né(e) le {{ update_request.birthDate | format_date }} ({{ update_request.applicant_age }} ans)
                  {% endif %}
                  <br />
                  {{ update_request.email }}
                </td>
                <td>
                  {% if update_request.user %}
                    {{ links.build_public_user_name_to_details_link(update_request.user) }}
                    {% if update_request.user.birth_date %}
                      <br />
                      {{ "né" | genderize(update_request.user.civility) }} le {{ update_request.user.birth_date | format_date }} ({{ update_request.user.age }} ans)
                    {% endif %}
                    <br />
                    {{ update_request.user.email }}
                  {% else %}
                    Compte jeune non trouvé
                  {% endif %}
                </td>
                <td>
                  {% if update_request.newEmail %}
                    <div>
                      <span class="fw-bold">Email&nbsp;:</span> {{ (update_request.user.email if update_request.user else "") + " => "}}{{ update_request.newEmail }}
                    </div>
                  {% endif %}
                  {% if update_request.newPhoneNumber %}
                    <div>
                      <span class="fw-bold">Téléphone&nbsp;:</span> {{ (update_request.user.phoneNumber if (update_request.user and update_request.user.phoneNumber) else "") + " => "}}{{ update_request.newPhoneNumber }}
                    </div>
                  {% endif %}
                  {% if update_request.newFirstName %}
                    <div>
                      <span class="fw-bold">Prénom&nbsp;:</span> {{ (update_request.user.firstName if update_request.user else "") + " => "}}{{ update_request.newFirstName }}
                    </div>
                  {% endif %}
                  {% if update_request.newLastName %}
                    <div>
                      <span class="fw-bold">Nom&nbsp;:</span> {{ (update_request.user.lastName if update_request.user else "") + " => "}}{{ update_request.newLastName }}
                    </div>
                  {% endif %}
                </td>
                <td>
                  {% if update_request.lastInstructor %}{{ update_request.lastInstructor.full_name }}{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="lead num-results">Aucune demande en cours</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
