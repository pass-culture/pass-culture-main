{% import "components/clipboard.html" as clipboard %}
{% import "components/links.html" as links %}
{% from "components/forms.html" import build_form_fields_group with context %}
{% from "components/generic_modal.html" import build_modal_form with context %}
{% from "components/presentation/details/tabs.html" import build_details_tab %}
{% from "components/presentation/details/tabs.html" import build_details_tabs_wrapper %}
{% from "components/presentation/details/tabs.html" import build_details_tab_content %}
{% from "components/presentation/details/tabs.html" import build_details_tabs_content_wrapper %}
{% from "components/turbo/spinner.html" import build_loading_spinner with context %}
{% extends "layouts/standard.html" %}
{% from "components/turbo/lazy_modal.html" import build_lazy_modal with context %}
{% block main_content %}
  <div class="row row-cols-1 g-4 py-3">
    <div class="col">
      <div class="card shadow">
        <div class="card-body">
          <div class="row justify-content-start align-items-center">
            <div class="col d-flex align-items-center justify-content-start">
              <h2 class="card-title mb-3 text-primary">{{ links.build_offer_name_to_pc_pro_link(offer) }}</h2>
              <span class="fs-5 ps-4">
                {% if offer.lastProviderId %}
                  <span class="me-2 badge rounded-pill text-bg-secondary align-middle">
                    <i class="bi bi-gear-fill"></i> {{ offer.lastProvider.name }}
                  </span>
                {% endif %}
              </span>
              {% if reindex_offer_form %}
                <div class="d-flex row-reverse justify-content-end flex-grow-1 px-3">
                  <form action="{{ url_for('.reindex', offer_id=offer.id) }}"
                        name="{{ url_for('.reindex', offer_id=offer.id) | action_to_name }}"
                        method="post">
                    {{ reindex_offer_form.csrf_token }}
                    <button class="btn btn-outline-primary lead fw-bold mt-2 justify-content-end">Resynchroniser l'offre dans Algolia</button>
                  </form>
                </div>
              {% endif %}
              {% if has_permission("MANAGE_OFFERS") %}
                <div class="d-flex row-reverse justify-content-start">
                  <a class=" px-3"
                     data-bs-toggle="modal"
                     data-bs-target="#edit-offer-modal-{{ offer.id }}">
                    <button class="btn btn-outline-primary lead fw-bold mt-2">Modifier l'offre</button>
                  </a>
                  {{ build_lazy_modal(url_for('backoffice_web.offer.get_edit_offer_form', offer_id=offer.id) , "edit-offer-modal-" + offer.id|string) }}
                </div>
              {% endif %}
              {% if has_permission("PRO_FRAUD_ACTIONS") %}
                <div class="d-flex row-reverse justify-content-start">
                  <a class=" px-3"
                     data-bs-toggle="modal"
                     data-bs-target="#validate-offer-modal-{{ offer.id }}">
                    <button class="btn btn-outline-primary lead fw-bold mt-2">Valider l'offre</button>
                  </a>
                  {{ build_lazy_modal(url_for('backoffice_web.offer.get_validate_offer_form', offer_id=offer.id) , "validate-offer-modal-" + offer.id|string) }}
                  <a class=" px-3"
                     data-bs-toggle="modal"
                     data-bs-target="#reject-offer-modal-{{ offer.id }}">
                    <button class="btn btn-outline-primary lead fw-bold mt-2">Rejeter l'offre</button>
                  </a>
                  {{ build_lazy_modal(url_for('backoffice_web.offer.get_reject_offer_form', offer_id=offer.id) , "reject-offer-modal-" + offer.id|string) }}
                </div>
              {% endif %}
              {% if edit_offer_venue_form %}
                {% set edit_offer_venue_aria_described_by_id = random_hash() %}
                {{ build_modal_form("edit-offer-venue", url_for("backoffice_web.offer.edit_offer_venue", offer_id=offer.id) , edit_offer_venue_form, "Modifier le lieu", "Modifier le lieu", "Enregistrer") }}
              {% endif %}
            </div>
            <div class="col-2"></div>
          </div>
          <p class="card-subtitle text-muted mb-3 h5">
            Offer ID : {{ offer.id }} {{ clipboard.copy_to_clipboard(offer.id, "Copier l'ID de l'offre") }}
          </p>
          <div class="row pt-3">
            <div class="col-4">
              <div class="fs-6">
                <p class="mb-1">
                  <span class="fw-bold">Catégorie :</span> {{ offer.subcategoryId | format_offer_category }}
                </p>
                <p class="mb-1">
                  <span class="fw-bold">Sous-catégorie :</span> {{ offer.subcategoryId | format_offer_subcategory }}
                </p>
                {% if offer.extraData.musicType or offer.extraData.musicSubType %}
                  <p class="mb-1">
                    <span class="fw-bold">Type de musique :</span>
                    {% if offer.extraData.musicType %}
                      {{ offer.extraData.musicType | format_music_type }}
                    {% else %}
                      [Non renseigné]
                    {% endif %}
                    -
                    {% if offer.extraData.musicSubType %}
                      {{ offer.extraData.musicSubType | format_music_subtype }}
                    {% else %}
                      [Non renseigné]
                    {% endif %}
                  </p>
                {% endif %}
                {% if offer.extraData.showType or offer.extraData.showSubType %}
                  <p class="mb-1">
                    <span class="fw-bold">Type de spectacle :</span>
                    {% if offer.extraData.showType %}
                      {{ offer.extraData.showType | format_show_type }}
                    {% else %}
                      [Non renseigné]
                    {% endif %}
                    -
                    {% if offer.extraData.showSubType %}
                      {{ offer.extraData.showSubType | format_show_subtype }}
                    {% else %}
                      [Non renseigné]
                    {% endif %}
                  </p>
                {% endif %}
                {% if offer.extraData.genres %}<span class="fw-bold">Genres :</span> {{ offer.extraData.genres | format_string_list }}{% endif %}
                {% if offer.withdrawalDetails %}
                  <p class="mb-1">
                    <span class="fw-bold">Modalités de retrait :</span> {{ offer.withdrawalDetails | replace("\n", "<br />"|safe) }}
                  </p>
                {% endif %}
              </div>
            </div>
            <div class="col-4">
              <div class="fs-6">
                <p class="mb-1">
                  <span class="fw-bold">Statut :</span> {{ offer.status | format_offer_status }}
                </p>
                <p class="mb-1">
                  <span class="fw-bold">État :</span> {{ offer.validation | format_offer_validation_status }}
                </p>
                <p class="mb-1">
                  <span class="fw-bold">Date de création :</span> {{ offer.dateCreated | format_date }}
                </p>
                {% if has_permission("PRO_FRAUD_ACTIONS") %}
                  {% set compliance_score = offer.extraData.get("complianceScore", "") if offer.extraData else "" %}
                  {% if compliance_score %}
                    <p class="mb-1">
                      <span class="fw-bold">Score data :</span> {{ compliance_score }}
                    </p>
                    {% set compliance_reasons = offer.extraData.get("complianceReasons") if offer.extraData else none %}
                    {% if compliance_reasons %}
                      <p class="mb-1">
                        <span class="fw-bold">Raison de score faible :</span> {{ compliance_reasons | format_compliance_reasons | safe }}
                      </p>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% if offer.lastValidationDate %}
                  <p class="mb-1">
                    <span class="fw-bold">Date de dernière validation :</span> {{ offer.lastValidationDate | format_date_time }}
                  </p>
                {% endif %}
                {% if offer.lastValidationAuthor %}
                  <p class="mb-1">
                    <span class="fw-bold">Utilisateur de la dernière validation :</span> {{ offer.lastValidationAuthor.full_name }}
                  </p>
                {% endif %}
                <p class="mb-1">
                  <span class="fw-bold">Tags :</span>
                  {{ offer.criteria | sort(attribute="name") | format_tag_object_list | safe }}
                </p>
              </div>
            </div>
            <div class="col-4">
              <div class="fs-6">
                <p class="mb-1">
                  <span class="fw-bold">Structure :</span> {{ links.build_offerer_name_to_details_link(offer.venue.managingOfferer) }}
                </p>
              </div>
              <div class="fs-6">
                <p class="mb-1">
                  <span class="fw-bold">Lieu :</span> {{ links.build_venue_name_to_details_link(offer.venue) }}
                </p>
              </div>
              {% if offer.offererAddress %}
                <div class="fs-6">
                  <p class="mb-1">
                    <span class="fw-bold">Adresse :</span>
                    <span class="fst-italic">{{ offer.offererAddress.label }}</span>
                    <br />
                    {{ offer.offererAddress.address.street }}
                    <br />
                    {{ offer.offererAddress.address.postalCode }} {{ offer.offererAddress.address.city }}
                    <br />
                    {{ links.build_external_address_link(offer.offererAddress.address) }}
                  </p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4">
        {% call build_details_tabs_wrapper() %}
          {{ build_details_tab("info", "Détails", active_tab == 'info') }}
          {{ build_details_tab("stock", "Stocks", active_tab == 'stock') }}
          {{ build_details_tab("bookings", "Réservations", active_tab == 'bookings') }}
        {% endcall %}
        {% call build_details_tabs_content_wrapper() %}
          {% call build_details_tab_content("stock", active_tab == 'stock') %}
            <table class="table mb-4 my-4">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Stock ID</th>
                  <th scope="col" class="col-2">Stock réservé</th>
                  <th scope="col" class="col-2">Stock restant</th>
                  <th scope="col" class="col-2">Prix</th>
                  {% if offer.isEvent %}
                    <th scope="col" class="col-2">Date / Heure</th>
                    <th scope="col" class="col-4">Fin des réservations</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for stock in offer.stocks | sort(attribute='id') %}
                  <tr>
                    <td>
                      {% if stock.id in editable_stock_ids and has_permission("MANAGE_OFFERS") %}
                        <div class="dropdown">
                          <button type="button"
                                  data-bs-toggle="dropdown"
                                  aria-expanded="false"
                                  class="btn p-0">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li class="dropdown-item">
                              <a class="btn btn-sm d-block w-100 text-start px-3"
                                 data-bs-toggle="modal"
                                 data-bs-target="#edit-offer-modal-{{ stock.id }}">Modifier</a>
                            </li>
                          </ul>
                        </div>
                      {% endif %}
                    </td>
                    <td>{{ stock.id }}</td>
                    <td>{{ stock.dnBookedQuantity }}</td>
                    <td>
                      {% if stock.isSoftDeleted %}
                        <span class="badge text-bg-light shadow-sm">supprimé</span>
                      {% elif stock.remainingStock is none %}
                        Illimité
                      {% else %}
                        {{ stock.remainingStock }}
                      {% endif %}
                    </td>
                    <td>{{ stock.price | format_amount }}</td>
                    {% if offer.isEvent %}
                      <td>{{ stock.beginningDatetime | format_date_time }}</td>
                      <td>{{ stock.bookingLimitDatetime | format_date_time }}</td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endcall %}
          {% call build_details_tab_content("bookings", active_tab == 'bookings') %}
            <div class="my-2 lead text-center">Exporter les réservations (choisir le format) :</div>
            <div class="d-flex justify-content-center align-items-center my-2">
              <div class="mx-2 fs-1">
                <a href="{{ url_for("backoffice_web.offer.download_bookings_csv", offer_id=offer.id) }}"
                   class="mx-2"><i class="bi bi-filetype-csv"
   data-bs-toggle="tooltip"
   data-bs-placement="top"
   data-bs-title="Télécharger au format CSV"></i></a>
              </div>
              <div class="mx-2 fs-1">
                <a href="{{ url_for("backoffice_web.offer.download_bookings_xlsx", offer_id=offer.id) }}"
                   class="mx-2"><i class="bi bi-filetype-xlsx"
   data-bs-toggle="tooltip"
   data-bs-placement="top"
   data-bs-title="Télécharger au format Excel"></i></a>
              </div>
            </div>
          {% endcall %}
          {% call build_details_tab_content("info", active_tab == 'info') %}
            <div class="container">
              <div class="row">
                <div class="col">
                  {% if offer.idAtProvider or offer.extraData.ean %}
                    <h3>Informations techniques</h3>
                    <div class="fs-6">
                      {% if offer.idAtProvider %}
                        <p class="mb-1">
                          <span class="fw-bold">Identifiant chez le fournisseur :</span> {{ offer.idAtProvider }}
                        </p>
                      {% endif %}
                      {% if offer.extraData.ean %}
                        <p class="mb-1">
                          <span class="fw-bold">EAN :</span> {{ offer.extraData.ean }}
                        </p>
                      {% endif %}
                    </div>
                  {% endif %}
                  <h3>Informations artistiques</h3>
                  <div class="fs-6">
                    {% if offer.extraData.author %}
                      <p class="mb-1">
                        <span class="fw-bold">Auteur :</span> {{ offer.extraData.author }}
                      </p>
                    {% endif %}
                    {% if offer.extraData.editeur %}
                      <p class="mb-1">
                        <span class="fw-bold">Éditeur :</span> {{ offer.extraData.editeur }}
                      </p>
                    {% endif %}
                    {% if offer.extraData.performer %}
                      <p class="mb-1">
                        <span class="fw-bold">Interprète :</span> {{ offer.extraData.performer }}
                      </p>
                    {% endif %}
                    {% if offer.durationMinutes %}
                      <p class="mb-1">
                        <span class="fw-bold">Durée :</span> {{ offer.durationMinutes }} minutes
                      </p>
                    {% endif %}
                    {% if offer.extraData.diffusionVersion %}
                      <p class="mb-1">
                        <span class="fw-bold">Langue :</span> {{ offer.extraData.diffusionVersion }}
                      </p>
                    {% endif %}
                    <p class="mb-1">
                      <span class="fw-bold">Description :</span> {{ offer.description | empty_string_if_null | replace("\n", "<br />"| safe) }}
                    </p>
                  </div>
                  <h3>Accessibilité</h3>
                  <div class="fs-6">
                    <p class="mb-1">
                      <span class="fw-bold">Accessible aux handicaps auditifs :</span> {{ offer.audioDisabilityCompliant | format_bool("Non renseigné") }}
                    </p>
                    <p class="mb-1">
                      <span class="fw-bold">Accessible aux handicaps mentaux :</span> {{ offer.mentalDisabilityCompliant | format_bool("Non renseigné") }}
                    </p>
                    <p class="mb-1">
                      <span class="fw-bold">Accessible aux handicaps moteurs :</span> {{ offer.motorDisabilityCompliant | format_bool("Non renseigné") }}
                    </p>
                    <p class="mb-1">
                      <span class="fw-bold">Accessible aux handicaps visuels :</span> {{ offer.visualDisabilityCompliant | format_bool("Non renseigné") }}
                    </p>
                  </div>
                </div>
                <div class="col-sm-2">
                  {% if offer.image %}
                    <img class="d-block pc-app-image-size"
                         src="{{ offer.image.url }}" />
                    {% if offer.image.credit %}Crédits: {{ offer.image.credit }}{% endif %}
                  {% else %}
                    <div class="empty-offer-image">
                      <p>Pas d’image</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endcall %}
        {% endcall %}
      </div>
    </div>
    {% if has_permission("MANAGE_OFFERS") %}
      {% for stock_id in editable_stock_ids %}
        {{ build_lazy_modal(url_for('backoffice_web.offer.get_offer_stock_edit_form', offer_id=offer.id, stock_id=stock_id) , "edit-offer-modal-" + stock_id|string) }}
      {% endfor %}
    {% endif %}
  </div>
{% endblock main_content %}
