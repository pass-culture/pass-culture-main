{% extends "layouts/list.html" %}
{% import "components/badges.html" as badges with context %}
{% from "components/display_selector.html" import display_selector %}
{% from "components/forms.html" import build_advanced_filters_form with context %}
{% from "components/dynamic/modal.html" import build_dynamic_modal with context %}
{% from "components/connect_as.html" import build_connect_as_link %}
{% from "components/table.html" import sortable_column %}
{% set rows_count = rows|length %}
{% set activate_sortable_columns = not date_created_sort_url %}
{% block title %}Offres individuelles{% endblock %}
{% block search_block %}
  {{ display_selector("form-selector-individual-offer", (
    (
    "Recherche exhaustive des offres",
    "Accédez à l’ensemble des offres, qu’elles soient réservables ou non, disponibles en base de données.",
    "advanced-search", page=="offer") ,
  (
  "Recherche des offres réservables sur l’app",
  "Remonte toutes les offres réservables sur l’app, en affichant une seule offre par produit. Si plusieurs acteurs proposent la même, une seule sera affichée.",
  "algolia-search", page=="algolia"
  ),
  (
  'Recherche sémantique <i class="bi bi-stars"></i>',
  "Recherchez des offres via une phrase, thématique ou question.",
  "llm-search-container",
  page=="llm"
  ),
  ), "px-1 mb-4") }}
  {{ build_advanced_filters_form(advanced_form, advanced_dst, "advanced-search") }}
  {{ build_advanced_filters_form(algolia_form, algolia_dst, "algolia-search") }}
  <div id="llm-search-container">
    <span class="fw-bold">Décrivez ce que vous cherchez :</span>
    <ol class="mb-4 ps-4">
      <li>Écrivez votre requête.</li>
      <li>Vous pouvez l’affiner grâce aux filtres (prix, date, département, catégorie…).</li>
    </ol>
    {{ build_advanced_filters_form(llm_form, llm_dst, "llm-search") }}
  </div>
{% endblock %}
{% set table_id = "offers-table" %}
{% block table_header %}
  <th scope="col"
      data-pc-column-name="Checkbox">
    <input type="checkbox"
           class="form-check-input fs-6 mt-0"
           name="pc-table-multi-select-check-all" />
  </th>
  <th scope="col">Actions</th>
  <th scope="col">Image</th>
  <th scope="col">ID</th>
  <th scope="col">Nom de l'offre</th>
  <th scope="col">EAN / Allociné ID</th>
  <th scope="col">Catégorie</th>
  <th scope="col">Sous-catégorie</th>
  {% if not has_permission("PRO_FRAUD_ACTIONS") %}
    <th scope="col"
        class="text-center">Stock réservé</th>
    <th scope="col"
        class="text-center">Stock restant</th>
  {% endif %}
  {% if has_permission("PRO_FRAUD_ACTIONS") or has_permission("VALIDATE_OFFERER") %}<th scope="col">Règles de conformité</th>{% endif %}
  {% if has_permission("PRO_FRAUD_ACTIONS") %}
    <th scope="col">Score data</th>
    <th scope="col">Prédiction de validité</th>
  {% endif %}
  {% call sortable_column(activate_sortable_columns, comparator="float", default_sort="up") %}
    Tarif
  {% endcall %}
  {% if has_permission("MANAGE_OFFERS_AND_VENUES_TAGS") %}<th scope="col">Tag</th>{% endif %}
  {% call sortable_column(activate_sortable_columns, comparator="float") %}
    Date(s) de l'évènement
  {% endcall %}
  {% call sortable_column(activate_sortable_columns, comparator="float") %}
    Date(s) limite(s) de réservation
  {% endcall %}
  <th scope="col">Créateur de l'offre</th>
  {% if has_permission("MANAGE_OFFERS_AND_VENUES_TAGS") %}
    <th data-pc-column-name="Pondération"
        scope="col">Pond.</th>
  {% endif %}
  <th scope="col">État</th>
  {% if date_created_sort_url %}
    <th scope="col">
      <a href="{{ date_created_sort_url }}"
         class="text-decoration-none"
         title="Changer pour un tri {{ 'croissant' if request.args.get("sort") == 'dateCreated' and request.args.get('order') == 'desc' else 'décroissant' }}">
        Date de création
        <i class="bi bi-sort-{{ 'down' if request.args.get("sort") == 'dateCreated' and request.args.get('order') == 'desc' else 'up' }}-alt"></i>
      </a>
    </th>
  {% else %}
    {% call sortable_column(activate_sortable_columns, comparator="float") %}
      Date de création
    {% endcall %}
  {% endif %}
  <th scope="col">Dernière validation</th>
  <th scope="col"
      data-pc-column-name="Département">Dép.</th>
  {% call sortable_column(activate_sortable_columns, default_sort="up") %}
    Entité juridique
  {% endcall %}
  {% call sortable_column(activate_sortable_columns, default_sort="up") %}
    Partenaire culturel
  {% endcall %}
  <th scope="col"
      data-pc-column-name="Toutes les offres du partenaire culturel">Offres du partenaire culturel</th>
  <th scope="col">Partenaire technique</th>
  <th scope="col"
      {%+ if page!="llm" %}
      data-pc-display-column="false"
      class="d-none"
      {% endif +%}
      data-bs-toggle="tooltip"
      data-bs-title="Pertinence générée par IA.">Pertinence</th>
{% endblock %}
{% block table_body %}
  {% include "offer/list_rows.html" %}
{% endblock %}
{% block multi_select_menu %}
  <div class="counter-container text-nowrap">
    <span class="counter">0</span> offre(s) sélectionnée(s)
  </div>
  {% if has_permission("PRO_FRAUD_ACTIONS") or has_permission("ADVANCED_PRO_SUPPORT") %}
    <form name="batch-ids-form"
          class="d-none">
      {{ csrf_token }}
      <input type="hidden"
             value=""
             name="selected-objects-ids">
    </form>
  {% endif %}
  {% if has_permission("PRO_FRAUD_ACTIONS") %}
    <div data-toggle="pc-batch-confirm-btn-group"
         data-toggle-id="table-container-individual-offer-fraud-btn-group"
         data-pc-table-multi-select-id="{{ table_name }}"
         data-input-ids-name="object_ids"
         class="d-flex">
      <button disabled
              type="button"
              class="btn border-end rounded-0 border-top-0 border-bottom-0 text-nowrap"
              data-use-dynamic-modal="true"
              data-bs-toggle="modal"
              data-bs-target="#batch-validate-offer-modal">
        Valider<i class="bi bi-hand-thumbs-up ps-2"></i>
      </button>
      <button disabled
              type="button"
              class="btn border-end rounded-0 border-top-0 border-bottom-0 text-nowrap"
              data-use-dynamic-modal="true"
              data-bs-toggle="modal"
              data-bs-target="#batch-reject-offer-modal">
        Rejeter<i class="bi bi-hand-thumbs-down ps-2"></i>
      </button>
    </div>
  {% endif %}
  {% if has_permission("ADVANCED_PRO_SUPPORT") %}
    <div data-toggle="pc-batch-confirm-btn-group"
         data-toggle-id="table-container-individual-offer-fraud-btn-group"
         data-pc-table-multi-select-id="{{ table_name }}"
         data-input-ids-name="object_ids"
         class="d-flex">
      <button disabled
              type="button"
              class="btn border-end rounded-0 border-top-0 border-bottom-0 text-nowrap"
              data-use-dynamic-modal="true"
              data-bs-toggle="modal"
              data-bs-target="#batch-activate-offer-modal">
        Publier<i class="bi bi-check-circle ps-2"></i>
      </button>
      <button disabled
              type="button"
              class="btn border-end rounded-0 border-top-0 border-bottom-0 text-nowrap"
              data-use-dynamic-modal="true"
              data-bs-toggle="modal"
              data-bs-target="#batch-deactivate-offer-modal">
        Mettre en pause<i class="bi bi-x-circle ps-2"></i>
      </button>
    </div>
  {% endif %}
  <div data-toggle="pc-batch-confirm-btn-group"
       data-toggle-id="table-container-individual-offer-edit-btn-group"
       data-pc-table-multi-select-id="{{ table_name }}"
       data-input-ids-name="object_ids"
       class="d-flex">
    <button disabled
            type="button"
            class="btn rounded-0 border-top-0 border-bottom-0 text-nowrap"
            data-use-dynamic-modal="true"
            data-bs-toggle="modal"
            data-bs-target="#batch-edit-offer-modal">
      Taguer / Pondérer<i class="bi bi-tag ps-2"></i>
    </button>
  </div>
{% endblock %}
{% block after_table %}
  {% for row in rows %}
    {% set offer = row.Offer %}
    {{ build_dynamic_modal(url_for('backoffice_web.offer.get_edit_offer_form', offer_id=offer.id) , "edit-offer-modal-" + offer.id|string) }}
    {{ build_dynamic_modal(url_for('backoffice_web.offer.get_validate_offer_form', offer_id=offer.id) , "validate-offer-modal-" + offer.id|string) }}
    {{ build_dynamic_modal(url_for('backoffice_web.offer.get_reject_offer_form', offer_id=offer.id) , "reject-offer-modal-" + offer.id|string) }}
    {{ build_dynamic_modal(url_for('backoffice_web.offer.get_deactivate_offer_form', offer_id=offer.id) , "deactivate-offer-modal-" + offer.id|string) }}
    {{ build_dynamic_modal(url_for('backoffice_web.offer.get_activate_offer_form', offer_id=offer.id) , "activate-offer-modal-" + offer.id|string) }}
  {% endfor %}
  {{ build_dynamic_modal(url_for("backoffice_web.offer.get_batch_validate_offers_form") , "batch-validate-offer-modal", method="post", form="form-ids-" + table_name) }}
  {{ build_dynamic_modal(url_for("backoffice_web.offer.get_batch_reject_offers_form") , "batch-reject-offer-modal", method="post", form="form-ids-" + table_name) }}
  {{ build_dynamic_modal(url_for("backoffice_web.offer.get_batch_activate_offers_form") , "batch-activate-offer-modal", method="post", form="form-ids-" + table_name) }}
  {{ build_dynamic_modal(url_for("backoffice_web.offer.get_batch_deactivate_offers_form") , "batch-deactivate-offer-modal", method="post", form="form-ids-" + table_name) }}
  {{ build_dynamic_modal(url_for("backoffice_web.offer.get_batch_edit_offer_form") , "batch-edit-offer-modal", method="post", form="form-ids-" + table_name) }}
{% endblock %}
{% block empty %}
  {% if not is_form_empty %}
    <div class="mt-5 d-flex justify-content-center">
      <div class="text-center">
        <svg class="mb-4"
             width="136"
             height="136"
             viewBox="0 0 136 136"
             fill="none"
             xmlns="http://www.w3.org/2000/svg">
          <path d="M60.7188 9.06641C93.5491 7.52961 121.399 32.8884 122.936 65.7188C123.408 75.8163 121.337 85.4771 117.25 94.0166C116.605 95.3639 114.991 95.9337 113.644 95.2891C112.296 94.6443 111.726 93.029 112.371 91.6816C116.078 83.9362 117.963 75.1633 117.532 65.9717C116.135 36.1255 90.8179 13.0726 60.9717 14.4697C31.1255 15.8669 8.07177 41.1841 9.46875 71.0303C10.866 100.877 36.1839 123.93 66.0303 122.533C75.3468 122.097 84.0059 119.319 91.4766 114.793C92.754 114.019 94.4174 114.428 95.1914 115.705C95.9654 116.983 95.5576 118.646 94.2803 119.42C86.0593 124.401 76.5261 127.457 66.2832 127.937C33.4528 129.473 5.60332 104.114 4.06641 71.2832C2.52972 38.4529 27.8884 10.6033 60.7188 9.06641ZM63.5 89.751C65.456 89.751 67.042 91.337 67.042 93.293C67.042 95.2489 65.456 96.8349 63.5 96.835C61.544 96.835 59.958 95.2489 59.958 93.293C59.958 91.337 61.544 89.751 63.5 89.751ZM63.5 40.168C65.0648 40.168 66.333 41.3748 66.333 42.8633V77.1396C66.3329 78.628 65.0647 79.8349 63.5 79.835C61.9353 79.835 60.6671 78.628 60.667 77.1396V42.8633C60.667 41.3748 61.9352 40.168 63.5 40.168Z" fill="#25026c" />
          <path d="M123.484 120.688C125.066 118.535 126 115.876 126 113C126 105.82 120.18 100 113 100C105.82 100 100 105.82 100 113C100 120.18 105.82 126 113 126C115.877 126 118.536 125.065 120.69 123.483L120.688 123.484C120.747 123.564 120.812 123.641 120.885 123.713L128.586 131.414C129.367 132.195 130.633 132.195 131.414 131.414C132.195 130.633 132.195 129.367 131.414 128.586L123.713 120.885C123.641 120.812 123.564 120.747 123.484 120.688ZM124 113C124 119.075 119.075 124 113 124C106.925 124 102 119.075 102 113C102 106.925 106.925 102 113 102C119.075 102 124 106.925 124 113Z" fill="#320096" />
        </svg>
        <div class="h2 text-primary">Aucune offre trouvée</div>
        <div class="h4">Vérifiez les filtres, ou reformulez la requête</div>
      </div>
    </div>
  {% endif %}
{% endblock %}
