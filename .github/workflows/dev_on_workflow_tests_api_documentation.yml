name: "3 [on_workflow/API] Tests"

on:
  workflow_call:
    inputs:
      doc-api-entrypoint:
        type: string
        required: false
        default: 'api/documentation'
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_EHP_SERVICE_ACCOUNT:
        required: true

env:
  registry: europe-west1-docker.pkg.dev/passculture-infra-prod/pass-culture-artifact-registry

defaults:
  run:
    working-directory: api

jobs:
  api-documentation-build-checks:
    name: "Check API documentation can be built"
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: '${{ inputs.doc-api-entrypoint }}/package.json'
      - uses: pass-culture/common-workflows/actions/setup-safe-chain@main
      - name: "Build documentation"
        run: |
          set -e
          npm install
          npm run build
        env:
          ENV: ci-tests
        working-directory: '${{ inputs.doc-api-entrypoint }}'

  end-slack-failure-notification:
    name: "Send workflow end failure"
    needs: api-documentation-build-checks
    if: always() && (failure() || cancelled())
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{vars.SLACK_DEV_CHANNEL_ID}}
      color: "#A30002"  # red
      message:
        ':github-failure: :github-failure: Les tests api-documentation-build-checks Ã©chouent sur `master`'
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
