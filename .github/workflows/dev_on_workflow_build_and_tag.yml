name: "3 [on_workflow] Build and tag"

# This reusable workflow should be called by another workflow.
# It builds then tags the release so it's ready to deploy.

on:
  workflow_call:
    inputs:
      base_ref:
        # The base ref to tag from.
        # Can be a branch name, a tag or a commit.
        required: true
        type: string

      tag_number:
        # 200.0.2 for example.
        required: true
        type: string

      base_ref_is_a_branch:
        required: false
        type: boolean
        default: false

    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER:
        required: true

      GCP_EHP_SERVICE_ACCOUNT:
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  build-images:
    name: Build Docker images
    strategy:
      matrix:
        image: [pcapi, pcapi-console]
    uses: ./.github/workflows/dev_on_workflow_build_docker_image.yml
    with:
      image: ${{ matrix.image }}
      tag: ${{ inputs.tag_number }}

  push-images:
    name: Push Docker images
    needs: [build-images]
    strategy:
      matrix:
        image: [pcapi, pcapi-console]
    uses: ./.github/workflows/dev_on_workflow_push_docker_image.yml
    with:
      image: ${{ matrix.image }}
      tag: ${{ inputs.tag_number }}
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

  tag-and-push-release:
    runs-on: ubuntu-22.04
    needs: [push-images]
    env:
      GIT_CONFIG_EMAIL: github-actions-bot@passculture.app
      GIT_CONFIG_NAME: ${{ github.actor }}
      TAG_NAME: v${{ inputs.tag_number }}
    steps:
      - name: Checkout ref
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.base_ref }}

      - name: Add version to api
        working-directory: api
        run: |
          echo "${{ inputs.tag_number }}" > version.txt
          git add version.txt

      - name: Add version to pro
        working-directory: pro
        run: |
          yarn version --new-version "${{ inputs.tag_number }}"
          git add package.json

      - name: Add version to image-resizing
        working-directory: app-engine/image-resizing
        run: |
          echo "${{ inputs.tag_number }}" > version.txt
          git add version.txt

      - name: Configure git author
        run: |
          git config --global user.email "$GIT_CONFIG_EMAIL"
          git config --global user.name "$GIT_CONFIG_NAME"

      - name: Authenticate through github app ghactionci
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: github-token
        with:
          app-id: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
          private-key: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: pass-culture-main
          permission-contents: write

      - name: Tag Release with github app  # so that another workflow can be triggered on push
        env:
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
        run: |
          git commit -m "ðŸš€ $TAG_NAME" -n
          git tag -a "$TAG_NAME" -m "ðŸš€ $TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Push tag to base ref
        if: ${{ inputs.base_ref_is_a_branch }}
        run: git push origin "${{ inputs.base_ref }}"
