name: "0 [on_dispatch/CD] Deploy release or hotfix"

run-name: "Deploy ${{ github.ref }} to ${{ github.event.inputs.target_environment }} by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      target_environment:
        type: choice
        description: "Environnement cible"
        required: true
        options:
          - staging
          - production
          - testing

permissions: write-all

jobs:
  check-workflow-ref:
    name: "Check workflow ref"
    runs-on: ubuntu-22.04
    steps:
      - name: "Check workflow ref"
        run: |
          echo "Deploying to ${{ github.event.inputs.target_environment }} from ref: ${{ github.ref }}"
          if ! [[ ${{ github.ref }} == refs\/tags\/v* ]]; then
            echo "This workflow can only be triggered from a tag (starting with a 'v')"
            exit 1
          fi

  ask-for-review-on-slack:
    name: "Ask for deployment review on Slack"
    needs: check-workflow-ref
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{ vars.SLACK_ALERTES_DEPLOIEMENT_CHANNEL_ID }}
      color: "#D4AD3B" # yellow
      message: ":github-pending: Un <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|déploiement> de `${{ github.ref_name }}` a été demandé sur `${{ github.event.inputs.target_environment }}`"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

  environment-short-name:
    name: "Environment short name"
    needs: check-workflow-ref
    # `deploy` is an artificial environment with protection rules, which allows a single required review instead of many
    environment: ${{ fromJSON('["deploy", "testing"]')[github.event.inputs.target_environment == 'testing'] }}
    runs-on: ubuntu-22.04
    outputs:
      ENVIRONMENT_SHORT_NAME: ${{ steps.environment-short-name.outputs.ENVIRONMENT_SHORT_NAME }}
    steps:
      - name: "Retrieve environment short name"
        id: "environment-short-name"
        run: |
          if [ "${{ github.event.inputs.target_environment }}" == "staging" ]; then
            echo "ENVIRONMENT_SHORT_NAME=stg" | tee -a $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.target_environment }}" == "production" ]; then
            echo "ENVIRONMENT_SHORT_NAME=prd" | tee -a $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT_SHORT_NAME=tst" | tee -a $GITHUB_OUTPUT
          fi

  version:
    name: "Version"
    needs: check-workflow-ref
    # `deploy` is an artificial environment with protection rules, which allows a single required review instead of many
    environment: ${{ fromJSON('["deploy", "testing"]')[github.event.inputs.target_environment == 'testing'] }}
    runs-on: ubuntu-22.04
    outputs:
      APP_VERSION: ${{ steps.app-version.outputs.APP_VERSION }}
    steps:
      - name: "Checkout Release"
        uses: actions/checkout@v6
        with:
          ref: "${{ github.ref }}"
          fetch-depth: 0
      - name: "Get app version"
        id: "app-version"
        run: echo APP_VERSION="$(cat ./api/version.txt)" | tee -a $GITHUB_OUTPUT

  deployment-confirmed:
    name: "Update message with deployment confirmation"
    needs: [ask-for-review-on-slack, version]
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{ vars.SLACK_ALERTES_DEPLOIEMENT_CHANNEL_ID }}
      method: update
      message-ts: ${{ needs.ask-for-review-on-slack.outputs.posted_message_ts }}
      color: "#28A745" # green
      message: ":rocket: Un <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|déploiement> de `${{ github.ref_name }}` a été approuvé sur `${{ github.event.inputs.target_environment }}`"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

  # DELETE THIS : mgeoffray 2025-09-04
  # As soon as we are confident in our staging automatic deployments
  deploy-ehp:
    name: "Deploy on EHP environnement"
    needs: version
    if: github.event.inputs.target_environment != 'production'
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: ${{ needs.environment-short-name.outputs.ENVIRONMENT_SHORT_NAME }}
      app_version: ${{ needs.version.outputs.APP_VERSION }}
      workflow_cluster_name: gke-infra-prd-eu9
      workflow_project_id: pc-infra-prd
      app_cluster_name: gke-backend-stg-eu9
      app_project_id: pc-backend-stg
      location: europe-west9
      is_new_infra: true
      workload_identity_provider_secret_name: gcp_metier_ehp_workload_identity_provider
      apply_algolia_config: true
      deploy_api: true
      deploy_pro: true
      doc-api-entrypoint: "api/documentation"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      NEW_INFRA_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PRD }}
      NEW_INFRA_PCAPI_DEPLOYER_SERVICE_ACCOUNT: ${{ secrets.PCAPI_CI_SERVICE_ACCOUNT_STG }}
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}

  deploy-integration-new-infra:
    name: "Deploy on integration environnement (new infra)"
    needs: 
      - version
    if: github.event.inputs.target_environment == 'production'
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: integration 
      environment_short_name: int
      app_version: ${{ needs.version.outputs.APP_VERSION }}
      workflow_cluster_name: gke-infra-prd-eu9
      workflow_project_id: pc-infra-prd
      app_cluster_name: gke-backend-stg-eu9
      app_project_id: pc-backend-stg
      location: europe-west9
      is_new_infra: true
      workload_identity_provider_secret_name: gcp_metier_ehp_workload_identity_provider
      apply_algolia_config: true
      deploy_api: true
      deploy_pro: true
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      NEW_INFRA_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PRD }}
      NEW_INFRA_PCAPI_DEPLOYER_SERVICE_ACCOUNT: ${{ secrets.PCAPI_CI_SERVICE_ACCOUNT_INT }}
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}

  deploy-integration:
    name: "Deploy on integration environnement"
    needs: 
      - version
      - deploy-integration-new-infra
    if: github.event.inputs.target_environment == 'production'
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: integration
      app_version: ${{ needs.version.outputs.APP_VERSION }}
      cluster_scope: metier
      cluster_environment: ehp
      workload_identity_provider_secret_name: gcp_metier_ehp_workload_identity_provider
      apply_algolia_config: true
      deploy_api: true
      deploy_pro: true
      doc-api-entrypoint: "api/documentation"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}


  deploy-prod:
    name: "Deploy on production environnement"
    needs: version
    if: github.event.inputs.target_environment == 'production'
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: ${{ github.event.inputs.target_environment }}
      app_version: ${{ needs.version.outputs.APP_VERSION }}
      cluster_scope: metier
      cluster_environment: prod
      workload_identity_provider_secret_name: gcp_metier_prod_workload_identity_provider
      apply_algolia_config: true
      deploy_api: true
      deploy_pro: true
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}

  deploy-prod-new-infra:
    name: "Deploy on production environnement"
    needs: 
      - version
      - deploy-prod
    if: github.event.inputs.target_environment == 'production'
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: ${{ github.event.inputs.target_environment }}
      environment_short_name: prd
      app_version: ${{ needs.version.outputs.APP_VERSION }}
      workflow_cluster_name: gke-infra-prd-eu9
      workflow_project_id: pc-infra-prd
      app_cluster_name: gke-backend-prd-eu9
      app_project_id: pc-backend-prd
      location: europe-west9
      is_new_infra: true
      workload_identity_provider_secret_name: gcp_metier_ehp_workload_identity_provider
      apply_algolia_config: true
      deploy_api: true
      deploy_pro: true
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      NEW_INFRA_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PRD }}
      NEW_INFRA_PCAPI_DEPLOYER_SERVICE_ACCOUNT: ${{ secrets.PCAPI_CI_SERVICE_ACCOUNT_PRD }}
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}

  publish-github-prerelease:
    runs-on: ubuntu-22.04
    needs: deploy-prod
    if: github.event.inputs.target_environment == 'production'
    steps:
      - uses: actions/checkout@v6
      - name: "Publish Github prerelease"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ github.ref_name }}" \
          --prerelease=false \
          --latest \
          --verify-tag

  end-slack-success-notification:
    name: "Send workflow success notification"
    needs: [version, deploy-prod, deploy-ehp]
    if: always() && !failure() && !cancelled()
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{vars.SLACK_ALERTES_DEPLOIEMENT_CHANNEL_ID}}
      color: "#28A745" # green
      message: ":github-success: La version `v${{ needs.version.outputs.APP_VERSION }}` a été <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|déployée> sur `${{ github.event.inputs.target_environment }}`"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

  end-slack-failure-notification:
    name: "Send workflow failure notification"
    needs: [version, deploy-prod, deploy-ehp]
    if: always() && (failure() || cancelled())
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{vars.SLACK_ALERTES_DEPLOIEMENT_CHANNEL_ID}}
      color: "#A30002" # red
      message: ":github-failure:Le <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|déploiement> de la version `v${{ needs.version.outputs.APP_VERSION }}` a échoué sur `${{ github.event.inputs.target_environment }}`"
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
