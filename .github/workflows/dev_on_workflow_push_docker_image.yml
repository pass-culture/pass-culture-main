name: '3 [on_workflow] push docker image'

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

      tag:
        required: true
        type: string

      tag_latest:
        required: false
        type: boolean
        default: false

    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        description: 'Workload Identity Provider for fetching secrets in Secret Manager'
        required: true
      SERVICE_ACCOUNT:
        description: 'Service Account for fetching secrets in Secret Manager'
        required: true

jobs:
  push-docker-image:
    name: Push Docker image to Artifact Registry
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - registry: europe-west-1-docker.pkg.dev
            project_id: passculture-infra-prod
            repository: pass-culture-artifact-registry
            cosign_kms_key_secret_name: passculture-metier-ehp/cosign
          - registry: europe-docker.pkg.dev
            project_id: pc-infra-prd
            repository: pass-culture-artifact-registry
            cosign_kms_key_secret_name: pc-infra-prd/cosign_kms_key
    steps:
      - name: Checkout new tag
        uses: actions/checkout@v5

      - name: Push built docker image to Artifact Registry ${{ matrix.registry }}
        uses: ./.github/actions/push-docker-image
        with:
          image: ${{ inputs.image }}
          tag: ${{ inputs.tag }}
          tag_latest: ${{ inputs.tag_latest }}
          artifact_registry_workload_identity_provider_secret_name: passculture-metier-ehp/infra-prod-gcp-workload-identity-provider
          artifact_registry_service_account_secret_name: passculture-metier-ehp/passculture-main-artifact-registry-service-account
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
          registry: ${{ matrix.registry }}
          project_id: ${{ matrix.project_id }}
          repository: ${{ matrix.repository }}
          cosign_kms_key_secret_name: ${{ matrix.cosign_kms_key_secret_name }}
