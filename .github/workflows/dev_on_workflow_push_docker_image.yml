name: '3 [on_workflow] push docker image'

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

      context:
        required: true
        type: string

      checksum_tag:
        required: true
        type: string

      artifact_registry_workload_identity_provider:
        required: false
        type: string

      artifact_registry_service_account:
        required: false
        type: string

      cosign_kms_key:
        required: false
        type: string

      registry:
        required: false
        type: string

      project_id:
        required: false
        type: string

      repository:
        required: false
        type: string

    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true

      SERVICE_ACCOUNT:
        required: true

      PRIVATE_KEY:
        required: true

      APP_ID:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  push-docker-image:
    name: Push Docker image
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5

      - name: Authentification to Google
        uses: google-github-actions/auth@v3
        with:
          create_credentials_file: true
          token_format: access_token
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Get Secret
        id: secrets
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |-
            COSIGN_KMS_KEY: ${{ inputs.cosign_kms_key }}
            ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER: ${{ inputs.artifact_registry_workload_identity_provider }}
            ARTIFACT_REGISTRY_SERVICE_ACCOUNT: ${{ inputs.artifact_registry_service_account }}

      - name: Authenticate through github app ghactionci
        id: github-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            pass-culture-main

      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.image }}-${{ inputs.checksum_tag }}.tar
          path: ${{ runner.temp }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker

      - name: Load docker image from artifact
        run: |
          docker load --input ${{ runner.temp }}/${{ inputs.image }}-${{ inputs.checksum_tag }}.tar

      - name: Build and push docker image
        id: build
        uses: pass-culture/common-workflows/actions/build-docker-image@build-docker-image/v0.2.0
        with:
          push: true
          image: ${{ inputs.image }}
          context: ${{ inputs.context }}
          build_secrets: |
            github-token=${{ steps.github-token.outputs.token }}
          gcp_workload_identity_provider: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER }}
          artifact_registry_service_account: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_SERVICE_ACCOUNT }}
          cosign_kms_key: ${{ steps.secrets.outputs.COSIGN_KMS_KEY }}
          docker_registry_region: ${{ inputs.registry }}
          docker_registry_project_id: ${{ inputs.project_id }}
          docker_registry_repository: ${{ inputs.repository }}
