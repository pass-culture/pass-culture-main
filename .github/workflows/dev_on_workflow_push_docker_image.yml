name: '3 [on_workflow] push docker image'

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

      tag:
        required: true
        type: string

      tag_latest:
        required: false
        type: boolean
        default: false

      registry:
        required: false
        type: string
        default: europe-west1-docker.pkg.dev

      project_id:
        required: false
        type: string
        default: passculture-infra-prod

      repository:
        required: false
        type: string
        default: pass-culture-artifact-registry

      artifact_registry_workload_identity_provider_secret_name:
        required: false
        type: string
        default: passculture-metier-ehp/infra-prod-gcp-workload-identity-provider

      artifact_registry_service_account_secret_name:
        required: false
        type: string
        default: passculture-metier-ehp/passculture-main-artifact-registry-service-account

      cosign_kms_key_secret_name:
        required: false
        type: string
        default: passculture-metier-ehp/cosign_kms_key

#    secrets:
#      workload_identity_provider:
#        required: true
#
#      service_account:
#        required: true

jobs:
  push-docker-image:
    name: Push Docker image to Artifact Registry
    runs-on: ubuntu-22.04
    steps:
      - name: Push built docker image to Artifact Registry
        uses: ./.github/actions/push-docker-image
        with:
          image: ${{ inputs.image }}
          tag: ${{ inputs.tag }}
          tag_latest: ${{ inputs.tag_latest }}
          artifact_registry_workload_identity_provider_secret_name: ${{ inputs.artifact_registry_workload_identity_provider_secret_name }}
          artifact_registry_service_account_secret_name: ${{ inputs.artifact_registry_service_account_secret_name }}
          cosign_kms_key_secret_name: ${{ inputs.cosign_kms_key_secret_name }}
          registry: ${{ inputs.registry }}
          project_id: ${{ inputs.project_id }}
          repository: ${{ inputs.repository }}
#        secrets:
#          workload_identity_provider: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
#          service_account: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
