name: "3 [on_workflow] Tests E2E Playwright"

on:
  workflow_call:
    inputs:
      ENV:
        type: string
        required: true
      image:
        type: string
        required: false
        default: pcapi-tests
      tag:
        type: string
        required: true
      CACHE_BUCKET_NAME:
        type: string
        required: true
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_EHP_SERVICE_ACCOUNT:
        required: true

defaults:
  run:
    working-directory: pro

jobs:
  install:
    name: "Install Playwright E2E ðŸ”§"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: "yarn"
          cache-dependency-path: "**/yarn.lock"
          node-version-file: "pro/package.json"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build vite application
        run: yarn build:${{ inputs.ENV }}

      - name: Save build folder
        uses: actions/upload-artifact@v6
        with:
          name: build-playwright
          if-no-files-found: error
          path: pro/build

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('**/Dockerfile', '**/docker-compose*.yml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Poetry
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: ${{ runner.os }}-buildx-

      - name: "Cache Workflow Conclusion"
        uses: technote-space/workflow-conclusion-action@v3

  playwright-run:
    name: "Run Playwright E2E"
    runs-on: ubuntu-24.04
    needs: [install]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: "Authentification to Google"
        uses: "google-github-actions/auth@v3"
        with:
          workload_identity_provider: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

      - name: "Get Secret"
        id: secrets
        uses: "google-github-actions/get-secretmanager-secrets@v3"
        with:
          secrets: |-
            ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER:passculture-metier-ehp/infra-prod-gcp-workload-identity-provider
            ARTIFACT_REGISTRY_SERVICE_ACCOUNT:passculture-metier-ehp/passculture-main-artifact-registry-service-account

      - uses: KengoTODA/actions-setup-docker-compose@v1
        with:
          version: "2.23.3"

      - name: "Fix local permissions"
        run: sudo chown -R $PCAPI_UID:$PCAPI_GID .
        working-directory: api
        env:
          PCAPI_UID: 1000
          PCAPI_GID: 1000

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: "yarn"
          cache-dependency-path: "**/yarn.lock"
          node-version-file: "pro/package.json"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Install Playwright browsers
        run: yarn playwright install chromium --with-deps

      - name: "OpenID Connect Authentication"
        id: openid-auth
        uses: "google-github-actions/auth@v3"
        with:
          create_credentials_file: false
          token_format: "access_token"
          workload_identity_provider: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER  }}
          service_account: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_SERVICE_ACCOUNT }}

      - name: "Docker login"
        id: docker-login
        uses: "docker/login-action@v3"
        with:
          registry: "europe-west1-docker.pkg.dev"
          username: "oauth2accesstoken"
          password: "${{ steps.openid-auth.outputs.access_token }}"

      - name: "Compute docker image name:tag"
        id: compute-image-name
        run: |
          echo "image_name=${{ inputs.image }}:${{ inputs.tag }}" | tee -a ${GITHUB_OUTPUT}
          echo "::notice:: Running playwright e2e-tests with ${{ inputs.image }}:${{ inputs.tag }}"

      - name: "Run postgres and redis server"
        run: docker-compose -f ../docker-compose-backend.yml up postgres redis -d

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v3"

      - name: "Download artifact"
        if: ${{ inputs.tag != 'latest' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.image }}-${{ inputs.tag }}.tar
          path: ${{ runner.temp }}

      - name: "Run API server"
        run: |
          if [ "${{ inputs.tag }}" != "latest" ]; then
            docker load --input ${{ runner.temp }}/${{ inputs.image }}-${{ inputs.tag }}.tar
          fi
          docker run \
            --name pc-api \
            --workdir /usr/src/app \
            --volume ./../api:/usr/src/app \
            --env-file ./../env_file \
            --tty \
            --detach \
            --network pass-culture-main_db_nw \
            --publish 5001:5001 \
            --publish 10002:10002 \
            --entrypoint bash \
            ${{ steps.compute-image-name.outputs.image_name }} \
            -c "set -e ; flask install_postgres_extensions ; alembic upgrade pre@head ; alembic upgrade post@head ; flask install_data ; FLASK_USE_RELOADER=0 python src/pcapi/app.py"

      - name: "Wait for migrations to be run"
        uses: iFaxity/wait-on-action@v1
        with:
          resource: http://localhost:5001/health/api
          timeout: 120000

      - name: Download the build folder
        uses: actions/download-artifact@v6
        with:
          name: build-playwright
          path: pro/build

      - name: "Serve vite preview"
        run: yarn serve &

      - name: "Wait for front-end to listen"
        run: |
          timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:3001)" != "200" ]]; do sleep 5; done' || false

      - name: "Playwright run"
        run: yarn playwright test -c ./config/playwright.config.ts --project=chromium

      - name: "Upload Playwright report"
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report-chromium
          path: pro/playwright-report/
          retention-days: 30

      - name: "Show pcapi log when it fails"
        if: failure()
        run: docker logs pc-api

  notify-playwright-failure:
    name: "Notification of Playwright tests failure"
    needs: playwright-run
    if: always() && needs.playwright-run.result == 'failure' && github.ref == 'refs/heads/master'
    uses: ./.github/workflows/dev_on_workflow_post_slack_message.yml
    with:
      channel: ${{vars.SLACK_DEV_CHANNEL_ID}}
      color: "#A30002"
      message: ":github-failure: <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|Pro Playwright E2E Tests> a Ã©chouÃ© sur `master`"
    secrets:
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
