name: "Test tests pro"

on:
  push:
    branches:
        - safe-chain-testing


permissions: write-all

jobs:

    build-pcapi-tests:
      name: "[pcapi-tests] build docker image."
      uses: ./.github/workflows/dev_on_workflow_build_docker_image.yml
      with:
        image: pcapi-tests
        tag: ${{ github.sha }}

    prepare-cache-master: # on "master" branch only
      name: "Reset cache on master on dependency update"
      needs: [build-pcapi-tests]
      uses: ./.github/workflows/dev_on_workflow_update_api_client_template.yml
      if: github.ref == 'refs/heads/master'
      with:
        PCAPI_DOCKER_TAG: ${{ github.sha }}
        TRIGGER_ONLY_ON_API_CHANGE: false
        TRIGGER_ONLY_ON_DEPENDENCY_CHANGE: true
        CACHE_BUCKET_NAME: "passculture-infra-prod-github-runner-cache"
        api-changed: false
        dependencies-changed: false
      secrets:
        GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
        GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}