name: "1 [analyze_timescaledb] Analyzing TimescaleDB"

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://pass_culture:passq@0.0.0.0:5434/pass_culture
      TIMESCALEDB_DATABASE_URL: postgresql://pass_culture:passq@0.0.0.0:5435/pass_culture
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: ./api
        run: |
          poetry install --no-interaction --no-ansi

      - name: Start Docker services
        run: |
          docker compose -f ./docker-compose-backend.yml up -d postgres timescaledb
          sleep 10

      - name: Wait for PostgreSQL to be ready
        run: |
          until docker compose -f ./docker-compose-backend.yml exec -T postgres pg_isready -U pass_culture; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Wait for TimescaleDB to be ready
        run: |
          until docker compose -f ./docker-compose-backend.yml exec -T timescaledb pg_isready -U pass_culture; do
            echo "Waiting for TimescaleDB..."
            sleep 2
          done

      - name: Run common migrations (old DB)
        working-directory: ./api
        run: |
          poetry run alembic upgrade pre@head
          poetry run alembic upgrade post@head

      - name: Run common migrations (new Timescale DB)
        working-directory: ./api
        env:
          DATABASE_URL_OVERRIDE: "postgresql://pass_culture:passq@localhost:5435/pass_culture"
        run: |
          poetry run alembic upgrade pre@head
          poetry run alembic upgrade post@head

      - name: Run new Timescale DB specific migrations
        working-directory: ./api
        run: poetry run alembic -c alembic_timescaledb.ini upgrade head

      - name: Seed base entities (old DB)
        working-directory: ./api
        run: poetry run python ../scripts/seed/01-seed_base_entities.py --port 5434 --num-users 100 --num-offerers 100

      - name: Seed base entities (new Timescale DB)
        working-directory: ./api
        run: poetry run python ../scripts/seed/01-seed_base_entities.py --port 5435 --num-users 100 --num-offerers 100

      - name: Show database status
        run: docker compose -f ./docker-compose-backend.yml ps

      - name: Cleanup
        if: always()
        run: docker compose -f ./docker-compose-backend.yml down -v
