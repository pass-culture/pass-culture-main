name: "1 [analyze_timescaledb] Analyzing TimescaleDB"

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://pass_culture:passq@0.0.0.0:5434/pass_culture
      TIMESCALEDB_DATABASE_URL: postgresql://pass_culture:passq@0.0.0.0:5435/pass_culture
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: ./api
        run: |
          poetry install --no-interaction --no-ansi

      - name: Start Docker services
        run: |
          docker compose -f ./docker-compose-backend.yml up -d postgres timescaledb
          sleep 10

      - name: Prepare databases (migrations
        run: |
          until docker compose -f ./docker-compose-backend.yml exec -T postgres pg_isready -U pass_culture; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          until docker compose -f ./docker-compose-backend.yml exec -T timescaledb pg_isready -U pass_culture; do
            echo "Waiting for TimescaleDB..."
            sleep 2
          done
          ./scripts/prepare/migrate.sh

      - name: Seed base entities
        working-directory: ./api
        run: poetry run python ../scripts/seed/01-seed_base_entities.py --num-users 100 --num-offerers 100

      - name: Seed venues
        working-directory: ./api
        run: poetry run python ../scripts/seed/02-seed_venues.py --num-venues 200

      - name: Seed offers
        working-directory: ./api
        run: poetry run python ../scripts/seed/03-seed_offers.py --num-offers 1000

      - name: Seed stocks
        working-directory: ./api
        run: poetry run python ../scripts/seed/04-seed_stocks.py --num-stocks 1000

      - name: Seed bookings
        working-directory: ./api
        run: poetry run python ../scripts/seed/05-seed_bookings.py --num-bookings 1000 --shard="1/1"

      - name: Cleanup
        if: always()
        run: docker compose -f ./docker-compose-backend.yml down -v
