name: "1 [on_push] Initiate workflow"

on:
  push:
    branches:
      - master
      - "maint/**"
  pull_request:
    branches-ignore:
      - docs

permissions: write-all

concurrency:
  # cancel previous workflow of the same branch except on master
  group: main-${{ github.ref }}
  cancel-in-progress: ${{ github.ref == 'refs/heads/master' && false || true }}

jobs:
  deploy-to-testing:
    name: "Deploy to testing"
    if: always()
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: testing
      app_version: ${{ github.sha }}
      teleport_version: 11.1.1
      teleport_proxy: teleport.ehp.passculture.team:443
      teleport_kubernetes_cluster: passculture-metier-ehp
      deploy_api: ${{ needs.test-api.result == 'success' }}
      deploy_pro: ${{ needs.test-pro.result == 'success' }}
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}

