name: '3 [on_workflow/Deprecated] Build and push docker images to Artifact Registry'

on:
  workflow_call:
    inputs:
      ref:
        # The git ref to build from.
        # Can be a branch name, a tag or a commit.
        required: false
        type: string
      tags:
        # The docker image tag(s)
        required: true
        type: string
      image:
        required: true
        type: string
    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_EHP_SERVICE_ACCOUNT:
        required: true

jobs:
  build-and-push-docker-images:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.5
        with:
          ref: ${{ inputs.ref }}
      - name: "Authentification to Google"
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      - name: "Get Secret"
        id: 'secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v2'
        with:
          secrets: |-
            ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER:passculture-metier-ehp/infra-prod-gcp-workload-identity-provider
            ARTIFACT_REGISTRY_SERVICE_ACCOUNT:passculture-metier-ehp/passculture-main-artifact-registry-service-account
      - name: "OpenID Connect Authentication"
        id: openid-auth
        uses: 'google-github-actions/auth@v2'
        with:
          create_credentials_file: false
          token_format: 'access_token'
          workload_identity_provider: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ steps.secrets.outputs.ARTIFACT_REGISTRY_SERVICE_ACCOUNT }}
      - name: 'Docker login'
        uses: 'docker/login-action@v3'
        id: "docker-login"
        with:
          registry: 'europe-west1-docker.pkg.dev'
          username: 'oauth2accesstoken'
          password: '${{ steps.openid-auth.outputs.access_token }}'
      - name: "Add version to api"
        working-directory: api
        run: |
          echo "${{ inputs.ref }}" > version.txt
          git add version.txt
      - name: "Install poetry"
        run: pip install poetry
      - name: "check poetry lock is up to date"
        working-directory: api
        run: poetry check
      - name: Replace image name in tags inputs
        id: define-docker-image-tags
        run: |
          echo "tags-to-push=${{ inputs.tags }}" | sed 's/DOCKER_IMAGE/${{ inputs.image }}/g'
          echo "tags-to-push=${{ inputs.tags }}" | sed 's/DOCKER_IMAGE/${{ inputs.image }}/g' >> "$GITHUB_OUTPUT"
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker
      - name: "Build and push ${{ inputs.image }} image"
        uses: docker/build-push-action@v5
        with:
          context: api
          push: true
          target: ${{ inputs.image }}
          tags: ${{ steps.define-docker-image-tags.outputs.tags-to-push }}
