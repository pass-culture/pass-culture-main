name: "3 [on_workflow] Dependabot auto-merge"

permissions:
  contents: write
  pull-requests: write

on:
  workflow_call:
    secrets:
      PASSCULTURE_GITHUB_ACTION_APP_ID:
        required: true
        description: "Github Application ID to use to clone other repos"
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY:
        required: true
        description: "Private key for the Github application used to clone other repos"

jobs:
  dependabot:
    runs-on: ubuntu-22.04
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Authenticate through github app ghactionci
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: github-token
        with:
          app-id: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }}
          private-key: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          # Liste des repositories Ã  cloner
          repositories: |
            pass-culture-main
          permission-contents: write
          permission-pull-requests: write
      - name: "Dependabot metadata"
        id: "metadata"
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ steps.github-token.outputs.token }}"
      - name: "Approve the PR"
        if: contains(steps.metadata.outputs.directory, 'pro') || contains(steps.metadata.outputs.directory, 'api/documentation')
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
      - name: "Merge Dependabot PR"
        if: contains(steps.metadata.outputs.directory, 'pro') || contains(steps.metadata.outputs.directory, 'api/documentation')
        run: gh pr merge --rebase "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{ steps.github-token.outputs.token }}
