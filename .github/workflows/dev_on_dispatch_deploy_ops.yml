name: "[DEVOPS][TEST][on_dispatch] Deploy OPS"

on:
  workflow_dispatch:
    inputs:
      pcapi_image_tag:
        description: pcapi image tag to deploy
        required: true
      deploy_new_infra:
        description: Deploy ops to new infra
        type: boolean
        default: true

permissions: write-all

jobs:
  deploy-to-ops:
    name: "Deploy to ops"
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: opsv2
      app_version: ${{ inputs.pcapi_image_tag }}
      cluster_name: gke-infra-prd-eu9
      location: europe-west9
      gcp_project_id: pc-infra-prd
      is_new_infra: ${{ inputs.deploy_new_infra }}
      workload_identity_provider_secret_name: gcp_metier_ops_workload_identity_provider # to delete after migration
      deploy_api: true
      cluster_scope: gke-backend-tst-eu9

    secrets:
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ inputs.deploy_new_infra && secrets.V2_GCP_WORKLOAD_IDENTITY_PROVIDER || secrets.GCP_WORKLOAD_IDENTITY_PROVIDER}} # To rename after migration for consistency
      GCP_EHP_SERVICE_ACCOUNT: ${{ inputs.deploy_new_infra && secrets.V2_GCP_SERVICE_ACCOUNT || secrets.V2_GCP_SERVICE_ACCOUNT }} # To rename after migration for consistency
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }} # to delete after migration
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }} # to delete after migration
