name: "[DEVOPS][TEST][on_dispatch] Deploy OPS"

on:
  workflow_dispatch:
    inputs:
      pcapi_image_tag:
        description: pcapi image tag to deploy
        required: true
      deploy_new_infra:
        description: Deploy ops to new infra
        type: boolean
        default: true

permissions: write-all

jobs:
  deploy-to-ops:
    name: "Deploy to ops"
    uses: ./.github/workflows/dev_on_workflow_deploy.yml
    with:
      environment: opsv2
      environment_short_name: opsv2
      app_version: ${{ inputs.pcapi_image_tag }}
      workflow_cluster_name: gke-infra-prd-eu9
      workflow_project_id: pc-infra-prd
      app_cluster_name: gke-backend-tst-eu9
      app_project_id: pc-backend-tst
      location: europe-west9
      is_new_infra: ${{ inputs.deploy_new_infra }}
      workload_identity_provider_secret_name: gcp_metier_ops_workload_identity_provider # to delete after migration
      deploy_api: true
    secrets:
      PASSCULTURE_GITHUB_ACTION_APP_ID: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_ID }} # to delete after migration
      PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY: ${{ secrets.PASSCULTURE_GITHUB_ACTION_APP_PRIVATE_KEY }} # to delete after migration
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      NEW_INFRA_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PRD }}
      NEW_INFRA_PCAPI_DEPLOYER_SERVICE_ACCOUNT: ${{ secrets.PCAPI_CI_SERVICE_ACCOUNT_OPSV2 }}
