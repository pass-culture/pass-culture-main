name: "Deploy PCAPI To new Infra"
description: "Deploy the Pass Culture API to Kubernetes"

inputs:
  environment:
    description: "Name of the environment in abbreviated format (tst,stg etc..)"
    required: true
  app_version:
    description: "Tag of the application to deploy"
    required: true
  location:
    description: "GCP Region"
    required: true
    default: europe-west9
  workflow_project_id:
    description: "ID of the project that hosts our workflow engine"
    required: true
  workflow_cluster_name:
    description: "Name of the cluster that hosts our workflow engine"
    required: true
  service_account:
    description: "PCAPI deployment service account"
    required: true
  workload_identity_provider:
    description: "Workload identity provider to perform authentication to GCP"
    required: true
  argo_template:
    description: "Name of the workflow template to run"
    required: false
    default: wfw-pcapi-full-deploy
  argo_cli_version:
    description: "Version of the workflow CLI"
    required: false
    default: "3.6.5"
  argo_namespace:
    description: "Namespace in which the workflow will run"
    required: false
    default: infra-cd-prd
  app_project_id:
    description: "ID of the project where the application is hosted"
    required: true
  app_cluster_name:
    description: "Name of the cluster that hosts the application"
    required: true
  prune_k8s_resources:
    description: "Prune k8s resources during deployment"
    required: false
    default: "false"
runs:
  using: composite
  steps:
    - name: "Install kubectl"
      uses: azure/setup-kubectl@v4

    - name: "Setup ArgoWF CLI"
      shell: bash
      run: |
        curl -sSL -o argo-linux-amd64.gz https://github.com/argoproj/argo-workflows/releases/download/v${{ inputs.argo_cli_version }}/argo-linux-amd64.gz
        gunzip "argo-linux-amd64.gz"
        sudo install -m 555 argo-linux-amd64 /usr/local/bin/argo
        rm argo-linux-amd64

    - name: "OpenID Connect Authentication"
      uses: "google-github-actions/auth@v3"
      with:
        service_account: ${{ inputs.service_account }}
        workload_identity_provider: ${{ inputs.workload_identity_provider}}

    # Trigger pre-migrations #
    - name: Authenticate to GKE cluster
      uses: google-github-actions/get-gke-credentials@v3
      with:
        cluster_name: ${{ inputs.app_cluster_name }}
        project_id: ${{ inputs.project_id }}
        location: ${{ inputs.location }}
        use_dns_based_endpoint: true

    - name: "Play pre-migrations"
      uses: pass-culture/common-workflows/actions/pcapi-migration@pcapi-migration/v0.3.1
      with:
        environment: "pcapi-${{ inputs.environment }}"
        app_version: ${{ inputs.app_version }}
        migration_type: pre
        artifact_registry: europe-docker.pkg.dev/pc-infra-prd/pass-culture-artifact-registry
    # End Trigger pre-migrations #

    # Trigger WF #
    - name: Authenticate to GKE cluster
      uses: google-github-actions/get-gke-credentials@v3
      with:
        cluster_name: ${{ inputs.workflow_cluster_name }}
        project_id: ${{ inputs.workflow_project_id }}
        location: ${{ inputs.location }}
        namespace: ${{ inputs.argo_namespace }}
        use_dns_based_endpoint: true

    - name: "ðŸ”€ Switch to ArgoCD namespace and Run Workflow ðŸš€"
      shell: bash
      run: |
        argo submit --from wftmpl/${{ inputs.argo_template }} \
          --log --wait \
          -p environment=${{ inputs.environment }} \
          -p pcapi_version=${{ inputs.app_version }} \
          -p prune_k8s_resources=${{ inputs.prune_k8s_resources }}
    # End Trigger WF #
    # Trigger post-migrations #
    - name: Authenticate to GKE cluster
      uses: google-github-actions/get-gke-credentials@v3
      with:
        cluster_name: ${{ inputs.app_cluster_name }}
        project_id: ${{ inputs.app_project_id }}
        location: ${{ inputs.location }}
        use_dns_based_endpoint: true

    - name: "Play post-migrations"
      uses: pass-culture/common-workflows/actions/pcapi-migration@pcapi-migration/v0.3.1
      with:
        environment: "pcapi-${{ inputs.environment }}"
        app_version: ${{ inputs.app_version }}
        migration_type: post
        artifact_registry: europe-docker.pkg.dev/pc-infra-prd/pass-culture-artifact-registry
    # End Trigger post-migrations #
