name: "Run post-deployment migrations for PCAPI (new infra)"
description: "Run post migrations (new infra)"

inputs:
  environment:
    description: "Name of the environment in abbreviated format (tst,stg etc..)"
    required: true
  app_version:
    description: "Tag of the application to deploy"
    required: true
  location:
    description: "GCP Region"
    required: true
    default: europe-west9
  service_account:
    description: "PCAPI deployment service account"
    required: true
  workload_identity_provider:
    description: "Workload identity provider to perform authentication to GCP"
    required: true
  argo_template:
    description: "Name of the workflow template to run"
    required: false
    default: wfw-pcapi-full-deploy
  app_project_id:
    description: "ID of the project where the application is hosted"
    required: true
  app_cluster_name:
    description: "Name of the cluster that hosts the application"
    required: true

runs:
  using: composite
  steps:
    - name: "Install kubectl"
      uses: azure/setup-kubectl@v4

    - name: "OpenID Connect Authentication"
      uses: "google-github-actions/auth@v3"
      with:
        service_account: ${{ inputs.service_account }}
        workload_identity_provider: ${{ inputs.workload_identity_provider}}

    # Trigger post-migrations #
    - name: Authenticate to GKE cluster
      uses: google-github-actions/get-gke-credentials@v3
      with:
        cluster_name: ${{ inputs.app_cluster_name }}
        project_id: ${{ inputs.app_project_id }}
        location: ${{ inputs.location }}
        use_dns_based_endpoint: true

    - name: "Play post-migrations"
      uses: pass-culture/common-workflows/actions/pcapi-migration@pcapi-migration/v0.3.1
      with:
        environment: "pcapi-${{ inputs.environment }}"
        app_version: ${{ inputs.app_version }}
        migration_type: post
        artifact_registry: europe-docker.pkg.dev/pc-infra-prd/pass-culture-artifact-registry
    # End Trigger post-migrations #