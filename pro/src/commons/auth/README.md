# Authentication & Routing System

This document describes the permission-based routing system under the `WIP_SWITCH_VENUE` feature flag.

---

- [Architecture Overview](#architecture-overview)
- [User Permissions](#user-permissions)
- [Loader-Based Permission Guard](#loader-based-permission-guard)
- [Redirect Priority Chain](#redirect-priority-chain)
- [Authentication Flow](#authentication-flow)
  - [With `WIP_SWITCH_VENUE` enabled](#with-wip_switch_venue-enabled)

---

## Architecture Overview

The system uses React Router's `loader` functions as middleware to enforce permissions before routes render. This approach:
- Runs permission checks before any component renders, avoiding the "flash" of unauthorized content (when a component briefly appears before the redirect kicks in).
- Handles redirects at the router level (not in React components).
- Makes permission requirements explicit on each route.
- Uses `revalidator.revalidate()` after state changes to trigger automatic re-evaluation.
- The `UserPermissions` object can later be generated by the Backend with minimal Frontend changes when authentication is refactored.
- Bonus ðŸŽ:
  - After logging in, you just have to call revalidator.revalidate();
  - After selecting a venue, you just have to call navigate('/accueil');

  The loader automatically handles redirects to the appropriate intermediate page (hub, onboarding, unattached page, etc.), so you no longer need to worry about determining the correct redirect based on current permissions.

```mermaid
graph TB
    subgraph "React Router"
        RP[RouterProvider]
        LD[Route Loaders]
    end

    subgraph "Permission Guard"
        WUP[withUserPermissions]
    end

    subgraph "Pages"
        PAGE[Page Component]
    end

    RP --> LD
    LD --> WUP
    WUP -->|allowed| PAGE
    WUP -->|not allowed| RP
```

## User Permissions

| Flag                        | Business Description                                          |
| --------------------------- | ------------------------------------------------------------- |
| `isAuthenticated`           | Is the user authenticated?                                    |
| `hasSelectedVenue`          | Has the user selected a venue?                                |
| `isSelectedVenueAssociated` | Is the venue selected by the user associated ("rattachÃ©e")?   |
| `isOnboarded`               | Is the user onboarded (= did they create at least one offer)? |

These flags are derived from Redux store state:

```mermaid
stateDiagram-v2
    state "Unauthenticated" as UNAUTH
    state "Authenticated" as AUTH
    state "Has Venue" as HAS_VENUE
    state "Venue Associated" as ASSOCIATED
    state "Onboarded" as ONBOARDED

    [*] --> UNAUTH: Initial state

    UNAUTH --> AUTH: Login success
    AUTH --> HAS_VENUE: Venue selected
    HAS_VENUE --> ASSOCIATED: access !== 'unattached'
    ASSOCIATED --> ONBOARDED: access !== 'no-onboarding'

    AUTH --> UNAUTH: Logout
    HAS_VENUE --> AUTH: Venue cleared
```



## Loader-Based Permission Guard

Each route uses `withUserPermissions` as a higher-order loader:

```ts
{
  path: '/accueil',
  loader: withUserPermissions(
    userPermissions =>
      userPermissions.isAuthenticated &&
      userPermissions.isSelectedVenueAssociated &&
      userPermissions.isOnboarded
  ),
  lazy: () => import('@/pages/Homepage/Homepage'),
}
```

The guard flow:

```mermaid
flowchart TB
    START([Route Navigation]) --> GET_STATE[Get Redux state]

    GET_STATE --> DERIVE[Derive current user permissions]
    DERIVE --> CHECK_PERM{User allowed?}

    CHECK_PERM -->|Yes| RUN_LOADER
    RUN_LOADER --> RENDER([Render page])

    CHECK_PERM -->|No| CALC_REDIRECT[Calculate redirect path]
    CALC_REDIRECT --> REDIRECT([redirect to path])
```

## Redirect Priority Chain

When a user is not allowed on a route, the guard redirects based on the first failing condition:

```mermaid
flowchart TB
    START([User not allowed]) --> C1{isAuthenticated?}

    C1 -->|No| R1("/connexion")
    C1 -->|Yes| C2{hasSelectedVenue?}

    C2 -->|No| R2("/hub")
    C2 -->|Yes| C3{isSelectedVenueAssociated?}

    C3 -->|No| R3("/rattachement-en-cours")
    C3 -->|Yes| C4{isOnboarded?}

    C4 -->|No| R4("/onboarding")
    C4 -->|Yes| R5("/accueil")
```

The final state (user has all permissions but is still not allowed) indicates an impossible/inconsistent state. In this case, the system logs an error and forces a logout to recover.

## Authentication Flow

The login process uses React Router's `revalidator` to trigger automatic redirection after state changes.

### With `WIP_SWITCH_VENUE` enabled

```mermaid
sequenceDiagram
    participant User
    participant Router as React Router
    participant Loader as Route Loader
    participant Login as SignIn Page
    participant API
    participant Store as Redux Store
    participant LocalStorage

    User->>Router: Access /accueil
    Router->>Loader: Execute withUserPermissions
    Note over Loader: isAuthenticated = false
    Loader->>Router: redirect('/connexion')
    Router->>User: Show /connexion

    User->>Login: Enter credentials
    Login->>API: POST /signin
    API-->>Login: Success + user data

    Login->>Store: dispatch(initializeUser)
    Note over Store: Fetch offererNames,<br/>fetch venues,<br/>set currentUser

    Store->>LocalStorage: Check for persisted venue ID

    alt Venue ID found in localStorage AND is valid
        Store->>Store: dispatch(setSelectedVenueById)
        Note over Store: Set selectedVenue,<br/>access = 'full'
    else User has exactly one venue
        Store->>Store: dispatch(setSelectedVenueById) with that venue
        Note over Store: Set selectedVenue,<br/>access = 'full'
    else Multiple venues or no venues
        Note over Store: No venue selected,<br/>access = null
    end

    Login->>Router: revalidator.revalidate()
    Router->>Loader: Re-execute withUserPermissions

    alt Has selected venue with full access
        Loader-->>Router: Allowed
        Router->>User: Show /accueil
    else No selected venue
        Loader->>Router: redirect('/hub')
        Router->>User: Show /hub (venue selection)
    end
```

Key points:
- After login, `initializeUser` uses simplified venue selection: localStorage venue ID or single venue auto-selection.
- If no venue is selected, the user is redirected to `/hub` to choose a venue.
- The SignIn page calls `revalidator.revalidate()` instead of explicit navigation.
- The route loader automatically determines the correct destination based on current permissions.
