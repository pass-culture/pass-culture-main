---
- name: Setup bastion server
  hosts: bastion
  become: true
  tasks:
    - name: Ensure scripts are copied
      copy:
        src: "{{Â item }}"
        dest: /usr/local/bin
        mode: "755"
      loop:
        - check_disk_space.sh
        - restore_prod_to_env.sh
        - restore_prod_to_env_new_region.sh
        - partial_backup/manage_backups.sh
        - partial_backup/partial_backup_restore.sh
        - partial_backup/partial_backup.sh
        - partial_backup/manage_tunnel.sh
        - backup_prod.sh
        - anonymize.sql
        - anonymize_database.sh
        - clean_old_backup.sh
        - clean_elasticsearch_indices.sh
        - clean_database.sql
      tags: scripts


    - name: Create /data/partial_backup directory
      file:
        path: /data/partial_backup
        state: directory
        owner: 'deploy'
      tags: scripts


    - name: Create /var/lib/scalingo directory
      file:
        path: /var/lib/scalingo
        state: directory
        owner: 'deploy'

    - name: Ensure user data files are copied
      copy:
        src: "{{ item }}"
        dest: "/var/lib/scalingo"
        owner: "deploy"
      loop:
        - "import_users.py"

    - name: Create /usr/local/bin/curator directory
      file:
        path: /usr/local/bin/curator
        state: directory
        owner: 'deploy'

    - name: Ensure curator files are copied
      copy:
        src: "{{ item }}"
        dest: "/var/lib/curator/"
        owner: "deploy"
      with_fileglob:
        - "curator/*"

    - name: Ensure cronfile file is up-to-date.
      copy:
        src: "cronfile"
        dest: "/tmp/"
      register: result
      tags: cron

    - name: Ensure cronfile file is active.
      become: false
      shell: crontab /tmp/cronfile
      when: result.changed
      tags: cron